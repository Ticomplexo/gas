<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>G√°s App 7.5 (Fix Pagamentos e Admin)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f8fafc;
            -webkit-tap-highlight-color: transparent;
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        #main-content { padding-bottom: 140px; padding-top: 10px; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .mb-safe { margin-bottom: env(safe-area-inset-bottom); }

        /* Navega√ß√£o Scrollable */
        .nav-scroll {
            display: flex;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none; 
        }
        .nav-scroll::-webkit-scrollbar { display: none; }

        .nav-item {
            flex: 0 0 auto;
            min-width: 70px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 8px 4px;
            color: #94a3b8;
            border-bottom: 3px solid transparent;
            transition: all 0.2s ease-in-out;
        }
        .nav-item.active {
            color: #4f46e5;
            border-color: #4f46e5;
            background-color: #f8fafc;
        }
        .nav-item:active { background-color: #f1f5f9; }

        /* Admin Tabs Scroll */
        .admin-scroll {
            display: flex;
            overflow-x: auto;
            gap: 0.5rem;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }
        .admin-scroll::-webkit-scrollbar { display: none; }

        /* Elementos UI */
        .product-card { transition: transform 0.1s; }
        .product-card:active { transform: scale(0.99); }
        .delivery-card { transition: all 0.2s; border-left: 4px solid #f59e0b; }
        .delivery-card.delivering { border-left-color: #4f46e5; background-color: #eef2ff; }
        
        /* Anima√ß√µes */
        @keyframes slideIn { from { transform: translateY(10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-slide { animation: slideIn 0.3s ease-out forwards; }
        .toast-enter { animation: slideIn 0.3s ease-out forwards; }
        
        .stepper-btn { width: 36px; height: 36px; border-radius: 10px; font-weight: 800; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }
    </style>
</head>
<body>

    <!-- Loading -->
    <div id="loading-screen" class="fixed inset-0 bg-white flex flex-col items-center justify-center z-50">
        <div class="animate-spin rounded-full h-12 w-12 border-b-4 border-indigo-600"></div>
        <p class="mt-4 text-indigo-700 font-bold text-sm tracking-wide animate-pulse">CARREGANDO v7.5...</p>
        <p id="loading-error" class="hidden mt-4 text-red-500 text-xs font-bold px-4 text-center"></p>
    </div>

    <!-- Toast -->
    <div id="toast-container" class="fixed top-4 left-0 w-full z-[90] p-4 pointer-events-none flex flex-col items-center gap-2"></div>

    <!-- App Container -->
    <div id="app-container" class="hidden min-h-screen flex flex-col">
        
        <!-- Header -->
        <header class="bg-white/90 backdrop-blur-md shadow-sm sticky top-0 z-40 border-b border-slate-100">
            <div class="px-5 py-3 flex justify-between items-center">
                <h1 class="text-xl font-black text-slate-800 flex items-center gap-2 tracking-tight">
                    <span class="text-2xl">üî•</span> G√°s Vendas
                </h1>
                <div class="text-[11px] font-bold text-slate-500 bg-slate-100 px-3 py-1.5 rounded-full border border-slate-200">
                    <span id="header-date">--/--/----</span>
                </div>
            </div>
            
            <!-- Abas -->
            <nav class="nav-scroll bg-white border-t border-slate-50">
                <button onclick="switchTab('vendas')" class="nav-item active" id="nav-vendas">
                    <span class="text-xl mb-0.5">üõí</span>
                    <span class="text-[10px] font-bold uppercase">Venda</span>
                </button>
                <button onclick="switchTab('entregas')" class="nav-item relative" id="nav-entregas">
                    <span class="text-xl mb-0.5">üõµ</span>
                    <span class="text-[10px] font-bold uppercase">Entregas</span>
                    <span id="badge-entregas" class="hidden absolute top-1 right-3 w-2.5 h-2.5 bg-red-500 rounded-full border border-white"></span>
                </button>
                <button onclick="switchTab('clientes')" class="nav-item" id="nav-clientes">
                    <span class="text-xl mb-0.5">üë•</span>
                    <span class="text-[10px] font-bold uppercase">Pedido</span>
                </button>
                <button onclick="switchTab('estoque')" class="nav-item" id="nav-estoque">
                    <span class="text-xl mb-0.5">üöö</span>
                    <span class="text-[10px] font-bold uppercase">Estoque</span>
                </button>
                <button onclick="switchTab('relatorios')" class="nav-item" id="nav-relatorios">
                    <span class="text-xl mb-0.5">üìä</span>
                    <span class="text-[10px] font-bold uppercase">Relat.</span>
                </button>
                <button onclick="switchTab('admin')" class="nav-item" id="nav-admin">
                    <span class="text-xl mb-0.5">‚öôÔ∏è</span>
                    <span class="text-[10px] font-bold uppercase">Admin</span>
                </button>
            </nav>
        </header>

        <!-- Main -->
        <main id="main-content" class="flex-1 p-4 bg-slate-50">
            
            <!-- 1. VENDAS (POS) -->
            <section id="tab-vendas" class="tab-content block">
                <div id="active-delivery-banner" class="hidden bg-indigo-100 border border-indigo-200 text-indigo-800 p-3 rounded-xl mb-4 flex justify-between items-center animate-slide">
                    <div>
                        <div class="text-[10px] font-bold uppercase opacity-60">Entregando para:</div>
                        <div class="font-bold text-sm" id="active-delivery-name">Cliente</div>
                    </div>
                    <button onclick="cancelActiveDelivery()" class="text-xs bg-white text-indigo-600 px-2 py-1 rounded font-bold border border-indigo-100">Cancelar</button>
                </div>

                <div class="mb-6">
                    <h2 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3 ml-1">Pagamento</h2>
                    <div id="pos-payment-grid" class="grid grid-cols-4 gap-3"></div>
                </div>

                <div>
                    <h2 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3 ml-1">Produtos</h2>
                    <div id="pos-product-list" class="space-y-4"></div>
                    <div class="h-32 w-full"></div> 
                </div>

                <div class="fixed bottom-0 left-0 w-full bg-white/95 backdrop-blur-xl border-t border-slate-200 shadow-[0_-8px_30px_rgba(0,0,0,0.04)] p-4 z-40 pb-safe">
                    <div class="flex justify-between items-end mb-4">
                        <div class="flex flex-col">
                            <span class="text-[11px] text-slate-500 font-bold uppercase tracking-wide">Total a Pagar</span>
                            <span class="text-3xl font-black text-indigo-700 leading-none tracking-tight" id="cart-total">‚Ç¨0,00</span>
                        </div>
                        <span class="text-xs bg-indigo-50 text-indigo-700 border border-indigo-100 px-3 py-1.5 rounded-full font-bold flex items-center gap-1">
                            üõí <span id="cart-count">0</span>
                        </span>
                    </div>
                    <button onclick="finishSale()" id="btn-checkout" disabled class="w-full bg-slate-900 text-white font-bold py-4 rounded-2xl shadow-xl shadow-slate-200 active:scale-[0.98] transition-all disabled:bg-slate-200 disabled:shadow-none disabled:text-slate-400 text-base">
                        Selecione Pagamento
                    </button>
                </div>
            </section>

            <!-- 2. ENTREGAS (COM GPS E OTIMIZA√á√ÉO AUTOM√ÅTICA) -->
            <section id="tab-entregas" class="tab-content hidden">
                <div class="flex flex-col gap-3 mb-4">
                    <div class="flex justify-between items-center">
                        <h2 class="text-lg font-black text-slate-800 tracking-tight">Entregas de Hoje</h2>
                        <span class="text-xs font-bold bg-orange-100 text-orange-700 px-2 py-1 rounded-lg" id="delivery-count">0 Pendentes</span>
                    </div>
                    
                    <!-- Ferramentas de Rota -->
                    <div class="grid grid-cols-2 gap-2" id="route-tools">
                        <button onclick="optimizeRoute()" class="bg-indigo-50 text-indigo-700 border border-indigo-100 py-2.5 rounded-xl font-bold text-xs flex items-center justify-center gap-2 active:scale-95 transition">
                            <span>üîÉ</span> For√ßar Re-Rota
                        </button>
                        <button onclick="openGoogleMapsRoute()" class="bg-green-50 text-green-700 border border-green-100 py-2.5 rounded-xl font-bold text-xs flex items-center justify-center gap-2 active:scale-95 transition">
                            <span>üó∫Ô∏è</span> Rota GPS
                        </button>
                    </div>
                </div>

                <div id="delivery-list" class="space-y-4">
                    <div class="text-center text-slate-400 py-10 font-medium text-sm">Nenhuma entrega pendente para hoje.</div>
                </div>
                <div class="h-24"></div>
            </section>

            <!-- 3. PEDIDO (CLIENTES) -->
            <section id="tab-clientes" class="tab-content hidden">
                <div class="bg-white p-6 rounded-[2rem] shadow-sm border border-slate-100 mb-6">
                    <h2 class="text-lg font-black text-slate-800 mb-6 flex items-center gap-2">
                        <span class="text-2xl">üìù</span> Novo Pedido
                    </h2>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1.5 ml-1 tracking-wider">Telefone</label>
                            <div class="relative">
                                <input type="tel" id="cust-phone" onkeyup="searchCustomer(this.value)" placeholder="Digite..." class="w-full p-4 bg-slate-50 rounded-2xl border border-slate-200 font-bold text-slate-800 outline-none focus:border-indigo-500 text-lg">
                                <span id="search-indicator" class="absolute right-4 top-4 text-slate-300">üîç</span>
                            </div>
                        </div>

                        <div>
                            <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1.5 ml-1 tracking-wider">Nome</label>
                            <input type="text" id="cust-name" class="w-full p-4 bg-slate-50 rounded-2xl border border-slate-200 font-bold text-slate-700 outline-none focus:border-indigo-500">
                        </div>

                        <div class="grid grid-cols-3 gap-3">
                            <div class="col-span-2">
                                <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1.5 ml-1 tracking-wider">Bairro</label>
                                <input type="text" id="cust-hood" class="w-full p-4 bg-slate-50 rounded-2xl border border-slate-200 font-bold text-slate-700 outline-none focus:border-indigo-500">
                            </div>
                            <div>
                                <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1.5 ml-1 tracking-wider">N√∫mero</label>
                                <input type="text" id="cust-num" class="w-full p-4 bg-slate-50 rounded-2xl border border-slate-200 font-bold text-slate-700 outline-none focus:border-indigo-500">
                            </div>
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1.5 ml-1 tracking-wider">Endere√ßo Completo</label>
                            <input type="text" id="cust-addr" class="w-full p-4 bg-slate-50 rounded-2xl border border-slate-200 font-bold text-slate-700 outline-none focus:border-indigo-500">
                        </div>
                        
                        <div>
                            <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1.5 ml-1 tracking-wider">Observa√ß√£o</label>
                            <textarea id="cust-obs" rows="2" class="w-full p-4 bg-slate-50 rounded-2xl border border-slate-200 font-bold text-slate-700 outline-none focus:border-indigo-500 text-sm"></textarea>
                        </div>
                    </div>

                    <div class="mt-8 pt-6 border-t border-slate-100">
                        <label class="block text-xs font-black text-indigo-600 uppercase mb-4 ml-1 tracking-wider">üì¶ Adicionar Produtos ao Pedido</label>
                        <div id="order-product-list" class="space-y-3">
                            <div class="text-center py-4 text-slate-400 text-sm">Carregando produtos...</div>
                        </div>
                    </div>

                    <button onclick="saveOrder()" class="w-full mt-6 bg-indigo-600 text-white font-bold py-4 rounded-2xl shadow-lg shadow-indigo-200 active:scale-95 transition text-lg">
                        Confirmar Pedido
                    </button>
                </div>
            </section>

            <!-- 4. ESTOQUE (PADRONIZADO E COM T√çTULO MAIOR) -->
            <section id="tab-estoque" class="tab-content hidden">
                <div class="bg-orange-50 rounded-3xl shadow-sm border border-orange-100 p-6 mb-6 relative overflow-hidden">
                    <h3 class="text-xl font-black text-orange-800 mb-4 flex items-center gap-2 relative z-10">
                        <span class="text-2xl">üöõ</span> Status do Ve√≠culo & Carga
                    </h3>
                    <div id="street-stock-grid" class="space-y-3 relative z-10">
                         <p class="text-slate-400 text-xs text-center py-4">Carregando...</p>
                    </div>
                    <div class="mt-4 pt-4 border-t border-orange-200/50 relative z-10">
                        <button onclick="updateStreetLoad()" class="w-full bg-orange-600 text-white font-bold py-4 rounded-xl shadow-lg shadow-orange-200 active:scale-95 transition text-sm flex justify-center items-center gap-2">
                            <span>üì¶</span> Confirmar Carga do Ve√≠culo
                        </button>
                    </div>
                </div>

                <div class="bg-white rounded-3xl shadow-sm border border-slate-100 p-6 mb-6">
                    <h3 class="text-sm font-bold text-slate-800 mb-5 flex items-center gap-2">
                        <span class="bg-blue-100 text-blue-600 p-1.5 rounded-lg text-lg">üè≠</span> Estoque Geral
                    </h3>
                    <div id="stock-summary-grid" class="grid grid-cols-2 gap-4">
                        <p class="text-slate-400 text-xs text-center col-span-2">Carregando...</p>
                    </div>
                    <p id="stock-empty-msg" class="hidden text-xs text-red-400 mt-2 font-bold text-center">‚ö†Ô∏è Estoque zerado. Adicione uma compra abaixo.</p>
                </div>
                
                <div class="bg-white rounded-3xl shadow-sm border border-slate-100 p-6 mb-6">
                    <h3 class="text-sm font-bold text-slate-800 mb-5 flex items-center gap-2">
                        <span class="bg-green-100 text-green-600 p-1.5 rounded-lg text-lg">üì•</span> Compra (Fornecedor)
                    </h3>
                    <div id="stock-inputs-list" class="space-y-4 mb-5">
                         <p class="text-slate-400 text-xs text-center">Carregando...</p>
                    </div>
                    <button onclick="addStockLoad()" class="w-full bg-slate-800 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-slate-200 active:scale-95 transition">Confirmar Entrada Geral</button>
                </div>
            </section>

            <!-- 5. RELAT√ìRIOS -->
            <section id="tab-relatorios" class="tab-content hidden">
                <div class="flex justify-between items-center mb-6 bg-white p-4 rounded-2xl border border-slate-100 shadow-sm">
                    <span class="text-sm font-bold text-slate-600">Data Base:</span>
                    <input type="date" id="report-date" class="bg-slate-50 border border-slate-200 text-slate-800 text-sm rounded-lg p-2 font-bold outline-none focus:border-indigo-500">
                </div>
                <button onclick="downloadPDF()" class="w-full mb-6 bg-slate-800 text-white font-bold py-3.5 rounded-2xl shadow-lg shadow-slate-200 active:scale-95 transition flex items-center justify-center gap-2"><span>üñ®Ô∏è</span> Baixar Relat√≥rio PDF</button>
                
                <div class="mb-6">
                    <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3 ml-1">Status dos Pedidos</h3>
                    <div class="grid grid-cols-4 gap-2">
                        <div class="bg-green-100 p-2 rounded-2xl text-center border border-green-200">
                            <span class="block text-[9px] font-bold text-green-700 uppercase">Entregues</span>
                            <span class="text-lg font-black text-green-800" id="report-status-done">0</span>
                        </div>
                        <div class="bg-yellow-100 p-2 rounded-2xl text-center border border-yellow-200">
                            <span class="block text-[9px] font-bold text-yellow-700 uppercase">Pendentes</span>
                            <span class="text-lg font-black text-yellow-800" id="report-status-pending">0</span>
                        </div>
                         <div class="bg-blue-100 p-2 rounded-2xl text-center border border-blue-200">
                            <span class="block text-[9px] font-bold text-blue-700 uppercase">Futuros</span>
                            <span class="text-lg font-black text-blue-800" id="report-status-future">0</span>
                        </div>
                        <div class="bg-red-100 p-2 rounded-2xl text-center border border-red-200">
                            <span class="block text-[9px] font-bold text-red-700 uppercase">Cancel</span>
                            <span class="text-lg font-black text-red-800" id="report-status-cancelled">0</span>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3 mb-6">
                    <div class="bg-gradient-to-br from-indigo-600 to-blue-600 text-white p-5 rounded-3xl shadow-lg relative overflow-hidden">
                        <p class="text-xs font-medium text-white/80 mb-1">Faturamento</p>
                        <p class="text-2xl font-black tracking-tight" id="report-kpi-value">‚Ç¨0,00</p>
                    </div>
                    <div class="bg-white text-slate-800 p-5 rounded-3xl shadow-sm border border-slate-100">
                        <p class="text-xs font-bold text-slate-400 uppercase mb-1">Vendas</p>
                        <p class="text-2xl font-black tracking-tight" id="report-kpi-count">0</p>
                    </div>
                </div>
                <div id="report-content" class="space-y-6"></div>
                 <div class="mt-8">
                     <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3 ml-1">Fluxo de Estoque (Dia)</h3>
                     <div id="stock-movement-report" class="bg-white p-5 rounded-3xl border border-slate-100 shadow-sm"></div>
                </div>
            </section>

            <!-- 6. ADMIN (EXPANDIDO) -->
            <section id="tab-admin" class="tab-content hidden">
                 <!-- Menu Admin com Scroll -->
                 <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-1.5 mb-6 admin-scroll">
                    <button onclick="switchAdminTab('prod')" id="admin-tab-prod" class="admin-tab-btn flex-1 py-2.5 text-xs rounded-xl active bg-slate-100 font-bold text-slate-800 whitespace-nowrap px-4 transition">Produtos</button>
                    <button onclick="switchAdminTab('clientes')" id="admin-tab-clientes" class="admin-tab-btn flex-1 py-2.5 text-xs rounded-xl text-slate-400 font-medium whitespace-nowrap px-4 transition">Clientes</button>
                    <button onclick="switchAdminTab('orders')" id="admin-tab-orders" class="admin-tab-btn flex-1 py-2.5 text-xs rounded-xl text-slate-400 font-medium whitespace-nowrap px-4 transition">Pedidos</button>
                    <button onclick="switchAdminTab('sales')" id="admin-tab-sales" class="admin-tab-btn flex-1 py-2.5 text-xs rounded-xl text-slate-400 font-medium whitespace-nowrap px-4 transition">Hist√≥rico</button>
                    <button onclick="switchAdminTab('pay')" id="admin-tab-pay" class="admin-tab-btn flex-1 py-2.5 text-xs rounded-xl text-slate-400 font-medium whitespace-nowrap px-4 transition">Pagamentos</button>
                </div>

                <!-- Painel Produtos -->
                <div id="admin-content-prod" class="admin-section block">
                    <div class="bg-white border border-slate-100 rounded-3xl p-5 shadow-sm mb-20">
                        <div id="admin-prod-list" class="divide-y divide-slate-50 mb-4"></div>
                        <button onclick="openProductModal('new')" class="w-full bg-indigo-600 text-white font-bold py-3.5 rounded-2xl shadow-lg">+ Novo Produto</button>
                    </div>
                </div>

                <!-- Painel Clientes -->
                <div id="admin-content-clientes" class="admin-section hidden">
                    <div class="mb-4">
                        <input type="text" onkeyup="renderAdminCustomerList(this.value)" placeholder="üîç Buscar Cliente (Nome ou Tel)..." class="w-full p-3.5 bg-white rounded-2xl border border-slate-200 font-bold text-slate-700 outline-none focus:border-indigo-500 shadow-sm">
                    </div>
                    <div id="admin-customer-list" class="space-y-3 pb-20"></div>
                </div>

                <!-- Painel Pedidos -->
                <div id="admin-content-orders" class="admin-section hidden">
                    <div class="flex justify-between items-center mb-4 px-2">
                        <h3 class="text-sm font-bold text-slate-400 uppercase">Todos os Pedidos Ativos</h3>
                    </div>
                    <div id="admin-order-list" class="space-y-3 pb-20"></div>
                </div>

                <!-- Painel Vendas (Hist√≥rico) -->
                <div id="admin-content-sales" class="admin-section hidden">
                    <div class="bg-white border border-slate-100 rounded-3xl p-5 shadow-sm mb-20">
                        <div id="admin-sales-list" class="space-y-3"></div>
                    </div>
                </div>

                <!-- Painel Pagamentos -->
                <div id="admin-content-pay" class="admin-section hidden mb-20">
                    <div class="bg-white border border-slate-100 rounded-3xl p-5 shadow-sm mb-6">
                        <div id="admin-pay-totals" class="space-y-3"></div>
                    </div>
                    <div class="bg-white border border-slate-100 rounded-3xl p-5 shadow-sm">
                        <div id="admin-pay-list" class="space-y-2 mb-4"></div>
                        <div class="flex gap-2">
                            <input type="text" id="new-pay-method" placeholder="Novo" class="flex-1 border border-slate-200 p-3 rounded-xl text-sm outline-none">
                            <button onclick="addPaymentMethod()" class="bg-green-600 text-white px-4 rounded-xl font-bold">+</button>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <!-- MODAIS -->
        <div id="modal-customer-edit" class="fixed inset-0 bg-slate-900/60 hidden items-center justify-center z-[80] p-4 backdrop-blur-sm"><div class="bg-white w-full max-w-sm rounded-[2rem] p-6 shadow-2xl h-[90vh] overflow-y-auto"><div class="flex justify-between items-center mb-6"><h3 class="text-xl font-black text-slate-800">Editar Cliente</h3><button onclick="closeModal('modal-customer-edit')" class="text-slate-400 font-bold text-xl">‚úï</button></div><div class="space-y-4"><input type="hidden" id="edit-cust-id"><div><label class="text-[10px] font-bold text-slate-400 uppercase">Telefone</label><input type="text" id="edit-cust-phone" readonly class="w-full p-3 bg-slate-100 rounded-xl font-bold text-slate-500 mb-2"></div><div><label class="text-[10px] font-bold text-slate-400 uppercase">Nome</label><input type="text" id="edit-cust-name" class="w-full p-3 bg-white border border-slate-200 rounded-xl font-bold text-slate-800"></div><div class="grid grid-cols-3 gap-2"><div class="col-span-2"><label class="text-[10px] font-bold text-slate-400 uppercase">Bairro</label><input type="text" id="edit-cust-hood" class="w-full p-3 bg-white border border-slate-200 rounded-xl font-bold text-slate-800"></div><div><label class="text-[10px] font-bold text-slate-400 uppercase">N¬∫</label><input type="text" id="edit-cust-num" class="w-full p-3 bg-white border border-slate-200 rounded-xl font-bold text-slate-800"></div></div><div><label class="text-[10px] font-bold text-slate-400 uppercase">Endere√ßo</label><input type="text" id="edit-cust-addr" class="w-full p-3 bg-white border border-slate-200 rounded-xl font-bold text-slate-800"></div><div><label class="text-[10px] font-bold text-slate-400 uppercase">Obs</label><textarea id="edit-cust-obs" class="w-full p-3 bg-white border border-slate-200 rounded-xl font-bold text-slate-800"></textarea></div></div><div class="mt-8 flex gap-3 flex-col"><button onclick="saveCustomerEdit()" class="w-full bg-indigo-600 text-white font-bold py-3.5 rounded-xl shadow-lg">Salvar Altera√ß√µes</button><button onclick="deleteCustomer()" class="w-full bg-red-50 text-red-500 font-bold py-3.5 rounded-xl">Excluir Cliente</button></div></div></div>
        <div id="modal-order-edit" class="fixed inset-0 bg-slate-900/60 hidden items-center justify-center z-[80] p-4 backdrop-blur-sm"><div class="bg-white w-full max-w-sm rounded-[2rem] p-6 shadow-2xl h-[90vh] overflow-y-auto flex flex-col"><div class="flex justify-between items-center mb-4"><h3 class="text-xl font-black text-slate-800">Editar Pedido</h3><button onclick="closeModal('modal-order-edit')" class="text-slate-400 font-bold text-xl">‚úï</button></div><input type="hidden" id="edit-order-id"><div class="flex-1 overflow-y-auto space-y-4"><div class="bg-slate-50 p-3 rounded-xl border border-slate-100"><div class="text-xs font-bold text-slate-400 uppercase mb-1">Endere√ßo de Entrega</div><input type="text" id="edit-order-addr" class="w-full p-2 bg-white border border-slate-200 rounded-lg text-sm font-bold text-slate-700 mb-2" placeholder="Rua"><div class="flex gap-2"><input type="text" id="edit-order-hood" class="w-2/3 p-2 bg-white border border-slate-200 rounded-lg text-sm font-bold text-slate-700" placeholder="Bairro"><input type="text" id="edit-order-num" class="w-1/3 p-2 bg-white border border-slate-200 rounded-lg text-sm font-bold text-slate-700" placeholder="N¬∫"></div></div><div><label class="block text-xs font-black text-indigo-600 uppercase mb-2">Produtos do Pedido</label><div id="edit-order-product-list" class="space-y-2"></div></div><div><label class="text-[10px] font-bold text-slate-400 uppercase">Observa√ß√£o</label><textarea id="edit-order-obs" rows="2" class="w-full p-2 bg-slate-50 border border-slate-200 rounded-xl font-bold text-slate-700 text-sm"></textarea></div></div><div class="mt-4 pt-4 border-t border-slate-100 flex flex-col gap-2"><button onclick="saveOrderEdit()" class="w-full bg-indigo-600 text-white font-bold py-3.5 rounded-xl shadow-lg">Confirmar Edi√ß√£o</button><button onclick="deleteActiveOrder()" class="w-full text-red-500 font-bold py-3.5 rounded-xl bg-red-50 hover:bg-red-100 transition">Excluir Pedido</button></div></div></div>
        <div id="modal-reschedule" class="fixed inset-0 bg-slate-900/60 hidden items-center justify-center z-[80] p-4 backdrop-blur-sm"><div class="bg-white w-full max-w-xs rounded-[2rem] p-6 shadow-2xl animate-[slideIn_0.2s_ease-out]"><h3 class="text-xl font-black text-slate-800 mb-2">üìÖ Reagendar</h3><p class="text-sm text-slate-500 font-medium mb-6">Para quando deseja mover este pedido?</p><input type="date" id="reschedule-date" class="w-full p-4 bg-slate-50 rounded-2xl border border-slate-200 font-bold text-slate-800 mb-6 outline-none focus:border-indigo-500"><div class="flex gap-3"><button onclick="closeModal('modal-reschedule')" class="flex-1 bg-slate-100 text-slate-700 font-bold py-3.5 rounded-xl">Cancelar</button><button onclick="confirmReschedule()" class="flex-1 bg-orange-500 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-orange-200">Confirmar</button></div></div></div>
        <div id="modal-confirm" class="fixed inset-0 bg-slate-900/60 hidden items-center justify-center z-[80] p-4 backdrop-blur-sm"><div class="bg-white w-full max-w-xs rounded-[2rem] p-6 shadow-2xl animate-[slideIn_0.2s_ease-out] text-center"><div class="w-14 h-14 bg-red-100 text-red-500 rounded-full flex items-center justify-center text-2xl mx-auto mb-4 font-black">!</div><h3 class="text-xl font-black text-slate-800 mb-2">Tem certeza?</h3><p class="text-sm text-slate-500 font-medium mb-6" id="modal-confirm-text">...</p><div class="flex gap-3"><button onclick="closeConfirmModal()" class="flex-1 bg-slate-100 text-slate-700 font-bold py-3.5 rounded-xl">N√£o</button><button id="btn-confirm-action" class="flex-1 bg-red-500 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-red-200">Sim</button></div></div></div>
        <div id="modal-product" class="fixed inset-0 bg-slate-900/40 hidden items-center justify-center z-[70] p-4 backdrop-blur-sm"><div class="bg-white w-full max-w-sm rounded-[2rem] p-8 shadow-2xl"><h3 class="text-2xl font-black mb-8" id="modal-prod-title">Produto</h3><div class="space-y-5"><div><input type="text" id="inp-prod-name" class="w-full p-4 bg-slate-50 rounded-2xl border border-slate-200 font-bold outline-none" placeholder="Nome"></div><div class="grid grid-cols-2 gap-4"><div><input type="number" id="inp-prod-price" class="w-full p-4 bg-slate-50 rounded-2xl border border-slate-200 font-bold outline-none" placeholder="Pre√ßo"></div><div><input type="number" id="inp-prod-stock" class="w-full p-4 bg-slate-50 rounded-2xl border border-slate-200 font-bold outline-none" placeholder="Estoque"></div></div></div><div class="mt-8 flex gap-3"><button onclick="closeModal('modal-product')" class="flex-1 bg-slate-100 font-bold py-4 rounded-2xl">Cancelar</button><button onclick="saveProduct()" class="flex-1 bg-indigo-600 text-white font-bold py-4 rounded-2xl shadow-lg">Salvar</button></div><button onclick="confirmDeleteProduct()" id="btn-delete-prod" class="w-full mt-4 text-red-400 text-xs font-bold">Excluir</button></div></div>
        <div id="modal-edit-sale" class="fixed inset-0 bg-slate-900/40 hidden items-center justify-center z-[70] p-4 backdrop-blur-sm"><div class="bg-white w-full max-w-sm rounded-[2rem] p-8 shadow-2xl"><h3 class="text-2xl font-black mb-2">Editar</h3><div class="space-y-5"><div><select id="edit-sale-prod" class="w-full p-4 bg-slate-50 rounded-2xl border border-slate-200 font-bold"></select></div><div><input type="number" id="edit-sale-qty" class="w-full p-4 bg-slate-50 rounded-2xl border border-slate-200 font-bold"></div><div><select id="edit-sale-pay" class="w-full p-4 bg-slate-50 rounded-2xl border border-slate-200 font-bold"></select></div></div><div class="mt-8 flex gap-3"><button onclick="closeModal('modal-edit-sale')" class="flex-1 bg-slate-100 font-bold py-4 rounded-2xl">Cancelar</button><button onclick="confirmEditSale()" class="flex-1 bg-indigo-600 text-white font-bold py-4 rounded-2xl shadow-lg">Confirmar</button></div></div></div>
        <div id="modal-adjust-cash" class="fixed inset-0 bg-slate-900/40 hidden items-center justify-center z-[70] p-4 backdrop-blur-sm"><div class="bg-white w-full max-w-sm rounded-[2rem] p-8 shadow-2xl"><h3 class="text-2xl font-black mb-2">Ajustar</h3><p class="mb-4 font-bold" id="adjust-method-name"></p><div><div id="adjust-current-val" class="text-2xl font-black mb-4"></div><input type="number" id="inp-adjust-val" class="w-full p-4 bg-indigo-50 rounded-2xl border border-indigo-100 font-black text-xl outline-none"></div><div class="mt-8 flex gap-3"><button onclick="closeModal('modal-adjust-cash')" class="flex-1 bg-slate-100 font-bold py-4 rounded-2xl">Cancelar</button><button onclick="confirmCashAdjustment()" class="flex-1 bg-green-600 text-white font-bold py-4 rounded-2xl shadow-lg">Salvar</button></div></div></div>

    </div>

    <!-- Script -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, getDoc, updateDoc, arrayUnion, increment, writeBatch, collection, deleteDoc, query, orderBy, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = JSON.parse('{"apiKey":"AIzaSyDVqXZHzoBNsFd8plj4bvvnXnw2zcvEmlk","authDomain":"vendas-gas.firebaseapp.com","projectId":"vendas-gas","storageBucket":"vendas-gas.firebasestorage.app","messagingSenderId":"477896574192","appId":"1:477896574192:web:fda4b5543aee74afb56e35","measurementId":"G-42GS09Z8PG"}');
        const APP_ID = 'vendas-gas';
        
        let db, auth;
        let state = {
            products: [],
            stock: {},
            streetStock: {},
            draftStreetStock: {},
            cart: {},
            orderCart: {},
            editingOrderCart: {},
            allCustomers: [],
            payment: '',
            paymentMethods: ['Dinheiro', 'Cart√£o', 'MBWay', 'Transfer√™ncia'],
            dailyData: null,
            allActiveOrders: [],
            todayDeliveries: [],
            activeDeliveryId: null,
            rescheduleId: null,
            editingProdId: null,
            editingSaleIndex: null,
            editingOrderId: null,
            adjustingMethod: null,
            pendingAction: null
        };
        
        // --- √çCONES DE PAGAMENTO ---
        const methodIcons = {
            'Dinheiro': 'üíµ',
            'Cart√£o': 'üí≥',
            'MBWay': 'üì±',
            'Transfer√™ncia': 'üè¶',
            'default': 'üí∞'
        };

        function generateUUID() {
            if (typeof crypto !== 'undefined' && crypto.randomUUID) {
                try { return crypto.randomUUID(); } catch(e){}
            }
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }
        
        setTimeout(() => {
            const loader = document.getElementById('loading-screen');
            if (loader && !loader.classList.contains('hidden')) {
                const err = document.getElementById('loading-error');
                err.classList.remove('hidden');
                err.innerHTML = 'Demorando muito? Verifique sua conex√£o ou recarregue.';
            }
        }, 5000);

        // --- INICIALIZA√á√ÉO ---
        const startApp = async () => {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                await signInAnonymously(auth);
                auth.onAuthStateChanged(user => { if(user) initData(); });
            } catch (e) { 
                document.getElementById('loading-error').classList.remove('hidden');
                document.getElementById('loading-error').textContent = 'Erro Fatal: ' + e.message;
            }
        };

        if (document.readyState === 'loading') { document.addEventListener('DOMContentLoaded', startApp); } else { startApp(); }

        function initData() {
            document.getElementById('loading-screen').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            const today = new Date();
            document.getElementById('header-date').textContent = new Intl.DateTimeFormat('pt-PT').format(today);
            document.getElementById('report-date').value = today.toISOString().split('T')[0];
            setupListeners();
        }

        function setupListeners() {
            const publicPath = `artifacts/${APP_ID}/public/data`;
            
            onSnapshot(doc(db, publicPath, 'MasterData/products'), snap => {
                if(snap.exists() && snap.data().list) { state.products = snap.data().list; } 
                else { 
                    const seed = [{id:'p1',name:'Butano',price:36},{id:'p2',name:'Propano',price:35}];
                    setDoc(doc(db, publicPath, 'MasterData/products'), {list:seed});
                    state.products = seed;
                }
                updateAllUI();
                renderOrderProductList(); 
            });
            onSnapshot(doc(db, publicPath, 'MasterData/config'), snap => {
                if(snap.exists() && snap.data().paymentMethods) state.paymentMethods = snap.data().paymentMethods;
                updateAllUI();
            });
            onSnapshot(doc(db, publicPath, 'MasterData/masterStock'), snap => {
                state.stock = snap.exists() ? snap.data() : {};
                updateAllUI();
            });
            onSnapshot(doc(db, publicPath, 'MasterData/streetStock'), snap => {
                state.streetStock = snap.exists() ? snap.data() : {};
                state.draftStreetStock = {}; 
                updateAllUI();
            });

            const ordersRef = collection(db, publicPath, 'ActiveOrders');
            onSnapshot(ordersRef, snap => {
                const list = [];
                snap.forEach(d => list.push(d.data()));
                state.allActiveOrders = list;
                filterDeliveriesForToday();
                renderAdminOrderList();
            });

            const customersRef = collection(db, publicPath, 'Customers');
            onSnapshot(customersRef, snap => {
                const list = [];
                snap.forEach(d => list.push({id: d.id, ...d.data()}));
                state.allCustomers = list;
                renderAdminCustomerList('');
            });

            const todayStr = document.getElementById('report-date').value;
            loadDayData(todayStr);
        }

        function filterDeliveriesForToday() {
            const todayStr = new Date().toISOString().split('T')[0]; 
            state.todayDeliveries = state.allActiveOrders.filter(o => {
                if(!o.scheduledDate) return true; 
                return o.scheduledDate <= todayStr; 
            });
            state.todayDeliveries.sort((a,b) => (a.orderIndex || 9999) - (b.orderIndex || 9999));
            renderDeliveryList();
            updateAllUI(); 
        }

        function updateAllUI() {
            try { renderPaymentMethods(); } catch(e){ console.error(e); }
            try { renderProducts(); } catch(e){ console.error(e); }
            try { renderStockUI(); } catch(e){ console.error(e); }
            try { renderAdminProdList(); } catch(e){ console.error(e); }
            try { renderAdminPaySettings(); } catch(e){ console.error(e); }
            if(!document.getElementById('tab-relatorios').classList.contains('hidden')) renderReportStatus();
        }

        // --- FUN√á√ÉO DE OTIMIZA√á√ÉO (AGORA REUTILIZ√ÅVEL) ---
        window.optimizeRoute = async (optionalList = null) => {
             // Se passarmos uma lista manual (ex: quando salvamos um novo pedido), usamos ela. 
             // Sen√£o, usamos o state atual (para o bot√£o manual)
             const listToOptimize = optionalList || [...state.todayDeliveries];

             // Ordena por Bairro (A-Z) e depois por Rua (A-Z)
             const sorted = listToOptimize.sort((a,b) => {
                 const hoodA = (a.hood || '').toLowerCase();
                 const hoodB = (b.hood || '').toLowerCase();
                 if (hoodA < hoodB) return -1;
                 if (hoodA > hoodB) return 1;
                 return (a.addr || '').localeCompare(b.addr || '');
             });

             // Atualiza os √≠ndices no banco
             const batch = writeBatch(db);
             const publicPath = `artifacts/${APP_ID}/public/data`;
             sorted.forEach((o, i) => {
                 const ref = doc(db, publicPath, `ActiveOrders/${o.id}`);
                 batch.update(ref, { orderIndex: i + 1 });
             });

             await batch.commit();
             
             if(!optionalList) showToast('Rota reordenada manualmente!');
        };

        // --- GOOGLE MAPS ---
        window.openGoogleMapsRoute = () => {
            if (state.todayDeliveries.length === 0) return showToast('Sem entregas hoje', 'error');
            const origin = "Minha Localiza√ß√£o";
            const waypoints = state.todayDeliveries.map(o => encodeURIComponent(`${o.addr}, ${o.num} - ${o.hood || ''}`));
            const destination = waypoints.pop();
            const waypointsStr = waypoints.join('|');
            const url = `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${destination}&waypoints=${waypointsStr}&travelmode=driving`;
            window.open(url, '_blank');
        };

        // --- RENDERIZA√á√ÉO ENTREGAS ---
        function renderDeliveryList() {
            const container = document.getElementById('delivery-list');
            const count = state.todayDeliveries.length;
            document.getElementById('delivery-count').textContent = `${count} Pendentes`;
            document.getElementById('badge-entregas').classList.toggle('hidden', count === 0);
            const tools = document.getElementById('route-tools');
            if(tools) tools.classList.toggle('hidden', count < 2);

            if(count === 0) {
                container.innerHTML = '<div class="text-center text-slate-400 py-10 font-medium text-sm">Nenhuma entrega pendente para hoje.</div>';
                return;
            }

            container.innerHTML = state.todayDeliveries.map((order, idx) => {
                const prodSummary = order.products.map(p => {
                    const prodName = state.products.find(x=>x.id===p.id)?.name || '???';
                    return `<span class="bg-indigo-50 text-indigo-700 px-2 py-1 rounded-lg text-xs font-bold">${p.qty}x ${prodName}</span>`;
                }).join(' ');
                const isDelivering = state.activeDeliveryId === order.id;
                const fullAddr = `${order.addr}, ${order.num} - ${order.hood || ''}`;
                const wazeLink = `https://waze.com/ul?q=${encodeURIComponent(fullAddr)}`;
                const mapsLink = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(fullAddr)}`;

                return `
                <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-4 delivery-card relative ${isDelivering ? 'delivering' : ''}">
                    <div class="mb-3 border-b border-slate-50 pb-2 flex justify-between items-start">
                        <div>
                            <div class="text-lg font-black text-slate-800 leading-tight">${order.hood || 'Sem Bairro'}</div>
                            <div class="text-sm font-medium text-slate-500">${order.addr}, ${order.num}</div>
                        </div>
                        <input type="number" onchange="updateOrderIndex('${order.id}', this.value)" value="${idx+1}" class="w-10 h-8 text-center bg-slate-100 rounded-lg font-bold text-slate-600 text-sm outline-none focus:ring-2 focus:ring-indigo-200" title="Ordem">
                    </div>
                    <div class="flex justify-between items-center mb-3 text-sm">
                        <div class="font-bold text-slate-700">üë§ ${order.name}</div>
                        <div class="flex gap-2">
                             <a href="${mapsLink}" target="_blank" class="bg-green-50 text-green-600 p-1.5 rounded-lg text-xs font-bold border border-green-100">üó∫Ô∏è</a>
                             <a href="${wazeLink}" target="_blank" class="bg-blue-50 text-blue-500 p-1.5 rounded-lg text-xs font-bold border border-blue-100">üöô</a>
                             <a href="tel:${order.phone}" class="bg-indigo-50 text-indigo-600 p-1.5 rounded-lg text-xs font-bold border border-indigo-100">üìû</a>
                        </div>
                    </div>
                    ${order.obs ? `<div class="bg-yellow-50 text-yellow-800 text-xs p-2 rounded-lg mb-3 font-medium">‚ö†Ô∏è ${order.obs}</div>` : ''}
                    <div class="flex flex-wrap gap-2 mb-4">${prodSummary}</div>
                    <div class="grid grid-cols-3 gap-2">
                        <button onclick="rejectOrder('${order.id}')" class="bg-red-50 text-red-500 font-bold py-2.5 rounded-xl text-xs hover:bg-red-100">Recusar</button>
                        <button onclick="openRescheduleModal('${order.id}')" class="bg-orange-50 text-orange-500 font-bold py-2.5 rounded-xl text-xs hover:bg-orange-100">Reagendar</button>
                        <button onclick="startDelivery('${order.id}')" class="bg-green-500 text-white font-bold py-2.5 rounded-xl text-xs shadow-md shadow-green-200 active:scale-95">Entregar ‚úÖ</button>
                    </div>
                </div>`;
            }).join('');
        }

        // --- CRIA√á√ÉO DE PEDIDO (COM AUTO-ROTEIRIZA√á√ÉO) ---
        window.saveOrder = async () => {
            const phone = document.getElementById('cust-phone').value.trim();
            const name = document.getElementById('cust-name').value.trim();
            if(!phone || !name) return showToast('Telefone e Nome obrigat√≥rios', 'error');

            const hasItems = Object.values(state.orderCart).some(v => v > 0);
            if(!hasItems) return showToast('Selecione produtos', 'error');

            const publicPath = `artifacts/${APP_ID}/public/data`;
            
            const custData = {
                name,
                hood: document.getElementById('cust-hood').value,
                addr: document.getElementById('cust-addr').value,
                num: document.getElementById('cust-num').value,
                obs: document.getElementById('cust-obs').value,
                phone
            };
            await setDoc(doc(db, publicPath, `Customers/${phone}`), custData, {merge:true});

            const orderId = 'ord_' + generateUUID();
            const scheduledDate = new Date().toISOString().split('T')[0];
            const productsList = [];
            Object.keys(state.orderCart).forEach(pid => {
                if(state.orderCart[pid] > 0) productsList.push({ id: pid, qty: state.orderCart[pid] });
            });

            const orderData = {
                id: orderId,
                customerId: phone,
                ...custData,
                products: productsList,
                status: 'pending',
                orderIndex: 99999, // Tempor√°rio, ser√° reordenado abaixo
                scheduledDate,
                ts: Date.now()
            };

            await setDoc(doc(db, publicPath, `ActiveOrders/${orderId}`), orderData);

            // AUTO-ROTEIRIZA√á√ÉO
            // Cria uma lista tempor√°ria com o estado atual + o novo pedido para reordenar j√°
            const tempList = [...state.todayDeliveries, orderData];
            await optimizeRoute(tempList);

            state.orderCart = {};
            document.querySelectorAll('#tab-clientes input').forEach(i => i.value = '');
            document.getElementById('cust-obs').value = '';
            document.getElementById('search-indicator').textContent = 'üîç';
            renderOrderProductList();
            
            showToast('Pedido salvo e rota recalculada! üîÑ', 'success');
            switchTab('entregas');
        };

        // --- EDI√á√ÉO DE PEDIDO (COM AUTO-ROTEIRIZA√á√ÉO) ---
        window.saveOrderEdit = async () => {
            const orderId = state.editingOrderId;
            if(!orderId) return;

            const newProducts = [];
            Object.keys(state.editingOrderCart).forEach(pid => {
                if(state.editingOrderCart[pid] > 0) newProducts.push({ id: pid, qty: state.editingOrderCart[pid] });
            });
            if(newProducts.length === 0) return showToast('Pedido deve ter itens', 'error');

            const updates = {
                addr: document.getElementById('edit-order-addr').value,
                hood: document.getElementById('edit-order-hood').value,
                num: document.getElementById('edit-order-num').value,
                obs: document.getElementById('edit-order-obs').value,
                products: newProducts
            };

            const publicPath = `artifacts/${APP_ID}/public/data`;
            await updateDoc(doc(db, publicPath, `ActiveOrders/${orderId}`), updates);
            
            // AUTO-ROTEIRIZA√á√ÉO (Bairro pode ter mudado)
            // Atualiza o objeto na lista atual e reordena
            const updatedList = state.todayDeliveries.map(o => {
                if(o.id === orderId) return { ...o, ...updates };
                return o;
            });
            await optimizeRoute(updatedList);

            closeModal('modal-order-edit');
            showToast('Atualizado e rota ajustada! üîÑ');
        };
        
        // --- NOVO: EXCLUIR PEDIDO (ADMIN) ---
        window.deleteActiveOrder = () => {
             const id = state.editingOrderId;
             if(!id) return;
             openConfirmModal(async () => {
                 const publicPath = `artifacts/${APP_ID}/public/data`;
                 await deleteDoc(doc(db, publicPath, `ActiveOrders/${id}`));
                 
                 // Re-roteiriza os pedidos de hoje se o exclu√≠do era de hoje
                 const remaining = state.todayDeliveries.filter(o => o.id !== id);
                 await optimizeRoute(remaining);
                 
                 closeModal('modal-order-edit');
                 showToast('Pedido exclu√≠do permanentemente!');
             }, "Tem certeza que deseja excluir este pedido permanentemente?");
        };

        // --- OUTROS ---
        window.updateOrderIndex = async (orderId, newIndex) => { const publicPath = `artifacts/${APP_ID}/public/data`; await updateDoc(doc(db, publicPath, `ActiveOrders/${orderId}`), { orderIndex: parseInt(newIndex) }); };
        
        // Recusar agora reordena os que sobraram para n√£o ficar buraco
        window.rejectOrder = (id) => { 
            openConfirmModal(async () => { 
                const order = state.allActiveOrders.find(o => o.id === id); 
                if (order) { 
                    const publicPath = `artifacts/${APP_ID}/public/data`; 
                    const dateStr = document.getElementById('report-date').value; 
                    await setDoc(doc(db, publicPath, `DailySales/${dateStr}`), { cancelled: arrayUnion({ ...order, cancelledAt: Date.now() }) }, {merge: true}); 
                } 
                await deleteDoc(doc(db, `artifacts/${APP_ID}/public/data/ActiveOrders/${id}`)); 
                
                // Re-calcula a rota com a lista filtrada (sem o removido)
                const remaining = state.todayDeliveries.filter(o => o.id !== id);
                await optimizeRoute(remaining);

                showToast('Pedido Recusado (Lista ajustada)'); 
            }, "Deseja recusar este pedido?"); 
        };

        // --- FUN√á√ïES DE SUPORTE (MANTIDAS) ---
        window.openRescheduleModal = (id) => { state.rescheduleId = id; const tomorrow = new Date(); tomorrow.setDate(tomorrow.getDate() + 1); document.getElementById('reschedule-date').value = tomorrow.toISOString().split('T')[0]; const modal = document.getElementById('modal-reschedule'); modal.classList.remove('hidden'); modal.classList.add('flex'); };
        window.confirmReschedule = async () => { const date = document.getElementById('reschedule-date').value; if(!date || !state.rescheduleId) return; const publicPath = `artifacts/${APP_ID}/public/data`; await updateDoc(doc(db, publicPath, `ActiveOrders/${state.rescheduleId}`), { scheduledDate: date, orderIndex: 99999 }); closeModal('modal-reschedule'); showToast(`Reagendado para ${date}`); };
        window.startDelivery = (id) => { const order = state.todayDeliveries.find(o => o.id === id); if(!order) return; state.cart = {}; order.products.forEach(p => state.cart[p.id] = p.qty); state.activeDeliveryId = id; document.getElementById('active-delivery-banner').classList.remove('hidden'); document.getElementById('active-delivery-name').textContent = `${order.name} (${order.hood})`; renderProducts(); switchTab('vendas'); showToast('Finalize a venda no caixa'); };
        window.cancelActiveDelivery = () => { state.activeDeliveryId = null; state.cart = {}; document.getElementById('active-delivery-banner').classList.add('hidden'); renderProducts(); showToast('Entrega cancelada (Mantida)'); };
        window.searchCustomer = async (phone) => { if(phone.length < 9) return; const publicPath = `artifacts/${APP_ID}/public/data`; const docRef = doc(db, publicPath, `Customers/${phone}`); try { const snap = await getDoc(docRef); const ind = document.getElementById('search-indicator'); if(snap.exists()) { const data = snap.data(); document.getElementById('cust-name').value = data.name || ''; document.getElementById('cust-hood').value = data.hood || ''; document.getElementById('cust-addr').value = data.addr || ''; document.getElementById('cust-num').value = data.num || ''; document.getElementById('cust-obs').value = data.obs || ''; ind.textContent = '‚úÖ'; ind.className = 'absolute right-4 top-4 text-green-500'; } else { ind.textContent = 'üÜï'; ind.className = 'absolute right-4 top-4 text-blue-500'; } } catch(e) { console.error(e); } };
        function renderOrderProductList() { const container = document.getElementById('order-product-list'); if(state.products.length === 0) { container.innerHTML = '<div class="text-center text-slate-400">Sem produtos cadastrados</div>'; return; } container.innerHTML = state.products.map(p => { const qty = state.orderCart[p.id] || 0; return `<div class="flex justify-between items-center bg-slate-50 p-4 rounded-2xl border border-slate-200"><span class="font-bold text-slate-700 text-lg">${p.name}</span><div class="flex items-center gap-3"><button onclick="updateOrderCart('${p.id}', -1)" class="stepper-btn bg-white border border-slate-200 text-slate-500 shadow-sm active:scale-90 transition">-</button><span class="font-bold w-8 text-center text-xl text-slate-800">${qty}</span><button onclick="updateOrderCart('${p.id}', 1)" class="stepper-btn bg-indigo-100 text-indigo-700 border border-indigo-200 shadow-sm active:scale-90 transition">+</button></div></div>`; }).join(''); }
        window.updateOrderCart = (id, d) => { const next = (state.orderCart[id] || 0) + d; if(next < 0) return; state.orderCart[id] = next; renderOrderProductList(); };
        function renderProducts() { 
            const pendingTotals = {}; 
            state.todayDeliveries.forEach(o => { o.products.forEach(p => { pendingTotals[p.id] = (pendingTotals[p.id] || 0) + p.qty; }); }); 
            const hasData = state.dailyData && state.dailyData.sales;
            document.getElementById('pos-product-list').innerHTML = state.products.map(p => { 
                const qty = state.cart[p.id] || 0; 
                const stock = state.stock[p.id] || 0; 
                const street = state.streetStock[p.id] || 0; 
                const soldToday = hasData ? state.dailyData.sales.filter(s => s.pid === p.id).length : 0; 
                const pending = pendingTotals[p.id] || 0; 
                return `<div id="card-${p.id}" class="product-card bg-white p-4 rounded-[1.5rem] shadow-sm border border-slate-100 mb-3 relative overflow-hidden"><div class="flex justify-between items-center mb-5"><div class="flex flex-col justify-center"><div class="font-bold text-slate-800 text-xl leading-none tracking-tight">${p.name}</div><div class="text-indigo-600 font-black text-2xl leading-none mt-1 tracking-tight">‚Ç¨${p.price}</div></div><div class="flex items-center gap-3 bg-slate-50 p-1.5 rounded-2xl border border-slate-100"><button onclick="updateCart('${p.id}', -1)" ${qty<=0?'disabled':''} class="w-12 h-12 flex items-center justify-center rounded-xl bg-white shadow-sm text-slate-500 font-bold disabled:opacity-30 disabled:shadow-none transition active:scale-90 text-2xl border border-slate-100">-</button><span class="font-black w-8 text-center text-2xl text-slate-800">${qty}</span><button onclick="updateCart('${p.id}', 1)" class="w-12 h-12 flex items-center justify-center rounded-xl bg-indigo-600 text-white font-bold transition active:scale-90 text-2xl shadow-lg shadow-indigo-200">+</button></div></div><div class="grid grid-cols-4 gap-2"><div class="bg-slate-100 text-slate-600 py-2 rounded-xl flex flex-col items-center justify-center"><span class="text-xs mb-0.5">üì¶</span><span class="font-black text-lg leading-none">${stock}</span></div><div class="bg-orange-50 text-orange-600 py-2 rounded-xl flex flex-col items-center justify-center border border-orange-100"><span class="text-xs mb-0.5">üöõ</span><span class="font-black text-lg leading-none">${street}</span></div><div class="bg-indigo-50 text-indigo-600 py-2 rounded-xl flex flex-col items-center justify-center border border-indigo-100" title="Total Encomendado"><span class="text-xs mb-0.5">üìù</span><span class="font-black text-lg leading-none">${pending}</span></div><div class="bg-green-50 text-green-700 py-2 rounded-xl flex flex-col items-center justify-center border border-green-100"><span class="text-xs mb-0.5">‚úÖ</span><span class="font-black text-lg leading-none">${soldToday}</span></div></div></div>`; 
            }).join(''); 
            checkCheckout(); 
        }
        window.updateCart = (id, d) => { const curr = state.cart[id] || 0; const stock = state.stock[id] || 0; const next = curr + d; if(next < 0) return; if(next > stock) return showToast('Estoque Geral Insuficiente', 'error'); state.cart[id] = next; renderProducts(); };
        window.setPayment = (m) => { state.payment = m; document.querySelectorAll('.payment-icon-btn').forEach(el => el.classList.remove('active')); document.getElementById(`pay-${m.replace(/\s/g,'')}`).classList.add('active'); checkCheckout(); };
        function checkCheckout() { let count = 0, total = 0; state.products.forEach(p => { const q = state.cart[p.id] || 0; count += q; total += q * p.price; }); document.getElementById('cart-count').textContent = count; document.getElementById('cart-total').textContent = '‚Ç¨' + total.toFixed(2); const btn = document.getElementById('btn-checkout'); if(count > 0 && state.payment) { btn.disabled = false; btn.textContent = `Finalizar (${state.payment})`; btn.classList.remove('bg-slate-900', 'text-white'); btn.classList.add('bg-green-600', 'text-white', 'shadow-green-200'); } else { btn.disabled = true; btn.textContent = state.payment ? 'Selecione Produtos' : 'Selecione Pagamento'; btn.classList.add('bg-slate-900', 'text-white'); btn.classList.remove('bg-green-600', 'text-white', 'shadow-green-200'); } }
        window.finishSale = async () => { const btn = document.getElementById('btn-checkout'); btn.textContent = 'Processando...'; btn.disabled = true; try { for (const p of state.products) { const q = state.cart[p.id] || 0; if (q > 0) { const currentStreet = state.streetStock[p.id] || 0; if (currentStreet < q) { throw new Error(`Estoque de Rua insuficiente para ${p.name}. Tem: ${currentStreet}, Pedido: ${q}`); } } } const salesToAdd = []; const publicPath = `artifacts/${APP_ID}/public/data`; const batch = writeBatch(db); const masterStockRef = doc(db, publicPath, 'MasterData/masterStock'); const streetStockRef = doc(db, publicPath, 'MasterData/streetStock'); const updatesMaster = {}; const updatesStreet = {}; state.products.forEach(p => { const q = state.cart[p.id] || 0; if(q > 0) { updatesMaster[p.id] = increment(-q); updatesStreet[p.id] = increment(-q); for(let i=0; i<q; i++) { salesToAdd.push({ id: generateUUID(), pid: p.id, price: p.price, method: state.payment, ts: Date.now() + i }); } } }); batch.update(masterStockRef, updatesMaster); batch.set(streetStockRef, updatesStreet, {merge: true}); if(state.activeDeliveryId) { const orderRef = doc(db, publicPath, `ActiveOrders/${state.activeDeliveryId}`); batch.delete(orderRef); } await batch.commit(); const realToday = new Date().toISOString().split('T')[0]; const freshStockSnap = await getDoc(masterStockRef); const freshStock = freshStockSnap.exists() ? freshStockSnap.data() : {}; const salesRef = doc(db, publicPath, `DailySales/${realToday}`); await setDoc(salesRef, { sales: arrayUnion(...salesToAdd), totalSales: increment(salesToAdd.length), totalValue: increment(salesToAdd.reduce((a,b)=>a+b.price,0)), finalStock: freshStock }, {merge: true}); state.cart = {}; state.payment = ''; state.activeDeliveryId = null; document.getElementById('active-delivery-banner').classList.add('hidden'); document.querySelectorAll('.payment-icon-btn').forEach(el => el.classList.remove('active')); renderProducts(); showToast('Venda Conclu√≠da!', 'success'); } catch(e) { showToast(e.message, 'error'); btn.disabled=false; } };
        
        // --- FUN√á√ÉO DE ESTOQUE BLINDADA E PADRONIZADA ---
        function renderStockUI() { 
            // 1. Verifica√ß√£o de Seguran√ßa
            if (!state.products || !Array.isArray(state.products) || state.products.length === 0) {
                 document.getElementById('street-stock-grid').innerHTML = '<p class="text-center text-slate-400 text-xs py-4">Nenhum produto cadastrado.</p>';
                 document.getElementById('stock-summary-grid').innerHTML = '<p class="text-center text-slate-400 text-xs py-4">Nenhum produto cadastrado.</p>';
                 document.getElementById('stock-inputs-list').innerHTML = '<p class="text-center text-slate-400 text-xs py-4">Cadastre produtos no Admin.</p>';
                 return;
            }

            try {
                let totalStock = 0; 
                
                // 2. Renderiza Estoque Geral (Padronizado)
                const summaryHtml = state.products.map(p => { 
                    totalStock += (state.stock[p.id] || 0); 
                    // MUDAN√áA AQUI: Padronizado para text-sm e slate-700
                    return `<div class="flex justify-between p-4 bg-slate-50 rounded-2xl border border-slate-100 items-center"><span class="text-sm font-bold text-slate-700">${p.name}</span><span class="text-base font-black ${!state.stock[p.id] ? 'text-red-500' : 'text-slate-800'}">${state.stock[p.id]||0}</span></div>`; 
                }).join(''); 
                document.getElementById('stock-summary-grid').innerHTML = summaryHtml; 
                document.getElementById('stock-empty-msg').classList.toggle('hidden', totalStock > 0); 
                
                // 3. Renderiza Estoque de Rua (Padronizado)
                const streetHtml = state.products.map(p => { 
                    const currentStreet = state.streetStock[p.id] || 0; 
                    const draftAdjustment = state.draftStreetStock[p.id] || 0; 
                    const finalValue = currentStreet + draftAdjustment; 
                    const displaySign = draftAdjustment > 0 ? '+' : ''; 
                    const displayColor = draftAdjustment > 0 ? 'text-green-600' : (draftAdjustment < 0 ? 'text-red-500' : 'text-slate-400'); 
                    // MUDAN√áA AQUI: Padronizado para text-sm e removido tamanho fixo min√∫sculo
                    return `<div class="bg-white rounded-2xl p-4 border border-orange-100 flex items-center justify-between"><div class="w-1/3"><div class="text-sm font-bold text-orange-900 uppercase truncate">${p.name}</div><div class="text-xs text-slate-400">Atual: <b class="text-slate-600">${currentStreet}</b></div></div><div class="flex items-center gap-3"><button onclick="adjustStreetDraft('${p.id}', -1)" class="w-10 h-10 rounded-xl bg-orange-50 text-orange-600 font-bold active:scale-90 transition border border-orange-100 text-xl">-</button><div class="flex flex-col items-center w-12"><span class="text-2xl font-black text-slate-800 leading-none">${finalValue}</span>${draftAdjustment !== 0 ? `<span class="text-[10px] font-bold ${displayColor}">${displaySign}${draftAdjustment}</span>` : ''}</div><button onclick="adjustStreetDraft('${p.id}', 1)" class="w-10 h-10 rounded-xl bg-orange-50 text-orange-600 font-bold active:scale-90 transition border border-orange-100 text-xl">+</button></div></div>`; 
                }).join(''); 
                document.getElementById('street-stock-grid').innerHTML = streetHtml; 
                
                // 4. Renderiza Inputs de Carga
                document.getElementById('stock-inputs-list').innerHTML = state.products.map(p => `<div class="flex items-center justify-between gap-3 bg-white p-2.5 rounded-xl border border-slate-50"><span class="text-sm font-bold text-slate-700 flex-1 leading-tight">${p.name}</span><input type="number" id="load-${p.id}" placeholder="Qtd" class="w-24 p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm font-bold text-slate-700 outline-none focus:border-indigo-500 transition text-center"></div>`).join(''); 
            
            } catch(e) {
                console.error("Erro ao renderizar estoque:", e);
                // Fallback silencioso para n√£o travar a UI
            }
        }

        window.adjustStreetDraft = (id, delta) => { const currentDraft = state.draftStreetStock[id] || 0; const currentStreet = state.streetStock[id] || 0; const newDraft = currentDraft + delta; if (currentStreet + newDraft < 0) return; state.draftStreetStock[id] = newDraft; renderStockUI(); }
        window.updateStreetLoad = async () => { const updates = {}; let has = false; let errorMsg = ''; for (const p of state.products) { const delta = state.draftStreetStock[p.id] || 0; if (delta !== 0) { const currentMaster = state.stock[p.id] || 0; if (delta > 0 && delta > currentMaster) { errorMsg = `Estoque Geral insuficiente de ${p.name} para carregar ${delta}.`; break; } updates[p.id] = increment(delta); has = true; } } if(errorMsg) return showToast(errorMsg, 'error'); if(!has) return showToast('Nenhuma altera√ß√£o', 'info'); const publicPath = `artifacts/${APP_ID}/public/data`; await setDoc(doc(db, publicPath, 'MasterData/streetStock'), updates, {merge: true}); state.draftStreetStock = {}; showToast('Carga Atualizada', 'success'); };
        function renderReportStatus() { const todayStr = new Date().toISOString().split('T')[0]; const delivered = state.dailyData ? state.dailyData.totalSales : 0; document.getElementById('report-status-done').textContent = delivered; const pending = state.todayDeliveries.length; document.getElementById('report-status-pending').textContent = pending; const future = state.allActiveOrders.filter(o => o.scheduledDate > todayStr).length; document.getElementById('report-status-future').textContent = future; const cancelled = state.dailyData && state.dailyData.cancelled ? state.dailyData.cancelled.length : 0; document.getElementById('report-status-cancelled').textContent = cancelled; }
        document.getElementById('report-date').addEventListener('change', (e) => loadDayData(e.target.value));
        async function loadDayData(dateStr) { if(!db) return; const publicPath = `artifacts/${APP_ID}/public/data`; onSnapshot(doc(db, publicPath, `DailySales/${dateStr}`), snap => { const data = snap.exists() ? snap.data() : { sales: [], cancelled: [], totalValue: 0, totalSales: 0, finalStock: null }; state.dailyData = data; renderReports(data); renderAdminSalesList(data); renderAdminPayTotals(data); renderStockFlow(data, dateStr); renderProducts(); if(!document.getElementById('tab-relatorios').classList.contains('hidden')) renderReportStatus(); }); }
        function renderReports(data) { document.getElementById('report-kpi-value').textContent = '‚Ç¨' + data.totalValue.toFixed(2); document.getElementById('report-kpi-count').textContent = data.totalSales; let html = ''; const byProd = {}; const byPay = {}; data.sales.forEach(s => { if(!byProd[s.pid]) byProd[s.pid] = { count: 0, total: 0 }; byProd[s.pid].count++; byProd[s.pid].total += s.price; byPay[s.method] = (byPay[s.method] || 0) + s.price; }); html += '<div class="bg-white rounded-3xl border border-slate-100 p-5 shadow-sm mb-4"><h3 class="text-xs font-bold text-slate-400 uppercase mb-4 tracking-wider">Produtos</h3>'; Object.keys(byProd).forEach(pid => { const p = state.products.find(x=>x.id===pid); const name = p ? p.name : '???'; html += `<div class="flex justify-between items-center text-sm p-2 hover:bg-slate-50 rounded-xl"><span class="font-bold text-slate-700">${name}</span><div class="flex gap-3 items-center"><span class="text-slate-500 bg-slate-100 px-2 py-1 rounded-lg text-xs font-bold">${byProd[pid].count} un</span><span class="font-bold text-indigo-600 w-20 text-right">‚Ç¨${byProd[pid].total.toFixed(2)}</span></div></div>`; }); html += '</div><div class="bg-white rounded-3xl border border-slate-100 p-5 shadow-sm"><h3 class="text-xs font-bold text-slate-400 uppercase mb-4 tracking-wider">Pagamentos</h3><div class="grid grid-cols-2 gap-3">'; Object.keys(byPay).forEach(m => html += `<div class="bg-slate-50 rounded-2xl p-4 text-center border border-slate-100"><div class="text-[10px] text-slate-400 font-bold uppercase mb-1">${m}</div><div class="text-lg font-black text-slate-800">‚Ç¨${byPay[m].toFixed(2)}</div></div>`); html += '</div></div>'; document.getElementById('report-content').innerHTML = html; }
        async function renderStockFlow(data, dateStr) { const publicPath = `artifacts/${APP_ID}/public/data`; const snap = await getDoc(doc(db, publicPath, 'MasterData/stockLoads')); const loads = (snap.exists() && snap.data().history) ? snap.data().history : []; const loadsToday = loads.filter(l => new Date(l.ts).toISOString().split('T')[0] === dateStr); const loadQty = loadsToday.reduce((a,b)=>a+b.qty,0); document.getElementById('stock-movement-report').innerHTML = `<div class="flex justify-between items-center text-sm mb-2"><div><span class="block text-slate-400 text-[10px] uppercase">Entradas</span><span class="font-black text-green-600">+${loadQty}</span></div><div><span class="block text-slate-400 text-[10px] uppercase">Sa√≠das</span><span class="font-black text-red-500">-${state.dailyData ? state.dailyData.totalSales : 0}</span></div></div>`; }
        function renderAdminSalesList(data) { const container = document.getElementById('admin-sales-list'); if(!data || !data.sales.length) return container.innerHTML = '<p class="text-slate-400 text-xs text-center py-6">Sem vendas.</p>'; container.innerHTML = data.sales.map((s, idx) => `<div class="flex justify-between items-center p-3 bg-slate-50 rounded-2xl border border-slate-100 text-sm mb-2"><div><div class="font-bold text-slate-700">${state.products.find(x=>x.id===s.pid)?.name||'Item'}</div><div class="text-xs text-slate-400">‚Ç¨${s.price} ‚Ä¢ ${s.method}</div></div><div class="flex gap-2"><button onclick="deleteSale(${idx})" class="text-red-500 font-bold px-3 py-1 bg-red-50 rounded-lg text-xs">X</button></div></div>`).join(''); }
        function renderAdminPayTotals(data) { const byPay = {}; data.sales.forEach(s => byPay[s.method] = (byPay[s.method] || 0) + s.price); document.getElementById('admin-pay-totals').innerHTML = state.paymentMethods.map(m => `<div class="flex justify-between items-center p-4 bg-slate-50 rounded-2xl border border-slate-100 mb-2"><div><div class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">${m}</div><div class="text-lg font-black text-slate-800">‚Ç¨${(byPay[m]||0).toFixed(2)}</div></div><button onclick="openAdjustModal('${m}', ${byPay[m]||0})" class="bg-indigo-50 text-indigo-600 px-4 py-2 rounded-xl text-xs font-bold">Ajustar</button></div>`).join(''); }
        function renderAdminProdList() { document.getElementById('admin-prod-list').innerHTML = state.products.map(p => `<div class="flex justify-between items-center py-4"><div><div class="font-bold text-slate-800 text-sm">${p.name}</div><div class="text-xs text-slate-500 font-medium mt-0.5">‚Ç¨${p.price}</div></div><button onclick="openProductModal('${p.id}')" class="text-indigo-600 font-bold text-xs bg-indigo-50 px-3 py-2 rounded-xl">Editar</button></div>`).join(''); }
        function renderAdminPaySettings() { document.getElementById('admin-pay-list').innerHTML = state.paymentMethods.map((m, idx) => `<div class="flex justify-between items-center p-3 bg-slate-50 rounded-2xl border border-slate-100 text-sm"><span class="font-bold text-slate-700">${m}</span><button onclick="removePaymentMethod(${idx})" class="text-red-400 font-bold px-2">‚úï</button></div>`).join(''); }
        window.downloadPDF = () => { const { jsPDF } = window.jspdf; const doc = new jsPDF(); const dateStr = document.getElementById('report-date').value; const data = state.dailyData; if (!data) return showToast('Sem dados', 'error'); doc.text(`Relat√≥rio ${dateStr}`, 14, 20); doc.text(`Total: ‚Ç¨${data.totalValue.toFixed(2)}`, 14, 30); if(data.cancelled) doc.text(`Cancelados: ${data.cancelled.length}`, 14, 40); doc.save(`relatorio_${dateStr}.pdf`); };
        window.addStockLoad = async () => { const updates = {}; const hist = []; let has=false; state.products.forEach(p => { const v = parseInt(document.getElementById(`load-${p.id}`).value); if(v > 0) { updates[p.id] = increment(v); hist.push({ts:Date.now(),name:p.name,qty:v}); has=true; } }); if(!has) return showToast('Preencha quantidades', 'error'); const publicPath = `artifacts/${APP_ID}/public/data`; await updateDoc(doc(db, publicPath, 'MasterData/masterStock'), updates); await setDoc(doc(db, publicPath, 'MasterData/stockLoads'), {history: arrayUnion(...hist)}, {merge:true}); state.products.forEach(p => document.getElementById(`load-${p.id}`).value = ''); showToast('Entrada Registrada', 'success'); };
        window.saveProduct = async () => { const name = document.getElementById('inp-prod-name').value; const price = parseFloat(document.getElementById('inp-prod-price').value); const stock = parseInt(document.getElementById('inp-prod-stock').value); if(!name) return; const publicPath = `artifacts/${APP_ID}/public/data`; let list = [...state.products]; const updates = {}; if(state.editingProdId) { const idx = list.findIndex(p => p.id === state.editingProdId); list[idx] = { ...list[idx], name, price }; updates[state.editingProdId] = stock; } else { const id = 'prod_' + Date.now(); list.push({ id, name, price }); updates[id] = stock; } await setDoc(doc(db, publicPath, 'MasterData/products'), { list }); await updateDoc(doc(db, publicPath, 'MasterData/masterStock'), updates); closeModal('modal-product'); };
        window.deleteProduct = async () => { const list = state.products.filter(p => p.id !== state.editingProdId); await setDoc(doc(db, `artifacts/${APP_ID}/public/data`, 'MasterData/products'), { list }); closeModal('modal-product'); };
        window.openProductModal = (id) => { document.getElementById('modal-product').classList.remove('hidden'); document.getElementById('modal-product').classList.add('flex'); if(id==='new') { state.editingProdId=null; document.getElementById('inp-prod-name').value=''; } else { state.editingProdId=id; const p=state.products.find(x=>x.id===id); document.getElementById('inp-prod-name').value=p.name; document.getElementById('inp-prod-price').value=p.price; document.getElementById('inp-prod-stock').value=state.stock[id]||0; } };
        window.closeModal = (id) => { document.getElementById(id).classList.add('hidden'); document.getElementById(id).classList.remove('flex'); };
        window.deleteSale = (idx) => { openConfirmModal(() => performDeleteSale(idx), "Estornar venda?"); };
        const performDeleteSale = async (idx) => { const sale = state.dailyData.sales[idx]; const newSales = state.dailyData.sales.filter((_, i) => i !== idx); const publicPath = `artifacts/${APP_ID}/public/data`; if(sale.pid !== 'adjustment') { const batch = writeBatch(db); batch.update(doc(db, publicPath, 'MasterData/masterStock'), { [sale.pid]: increment(1) }); batch.set(doc(db, publicPath, 'MasterData/streetStock'), { [sale.pid]: increment(1) }, {merge: true}); await batch.commit(); } const dateStr = document.getElementById('report-date').value; await setDoc(doc(db, publicPath, `DailySales/${dateStr}`), { sales: newSales, totalSales: newSales.length, totalValue: newSales.reduce((a,b)=>a+b.price,0) }, {merge:true}); showToast('Estornado'); };
        window.switchTab = (id) => { document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden')); document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active')); document.getElementById(`tab-${id}`).classList.remove('hidden'); document.getElementById(`nav-${id}`).classList.add('active'); if(id === 'relatorios') loadDayData(document.getElementById('report-date').value); if(id === 'clientes') renderOrderProductList(); if(id === 'estoque') renderStockUI(); };
        window.switchAdminTab = (tab) => { document.querySelectorAll('.admin-section').forEach(el => el.classList.add('hidden')); document.querySelectorAll('.admin-tab-btn').forEach(el => { el.classList.remove('active', 'bg-slate-100', 'font-bold', 'text-slate-800'); el.classList.add('text-slate-400'); }); document.getElementById(`admin-content-${tab}`).classList.remove('hidden'); const btn = document.getElementById(`admin-tab-${tab}`); btn.classList.add('active', 'bg-slate-100', 'font-bold', 'text-slate-800'); btn.classList.remove('text-slate-400'); };
        window.openConfirmModal = (action, text = "Essa a√ß√£o n√£o pode ser desfeita.") => { state.pendingAction = action; document.getElementById('modal-confirm-text').textContent = text; document.getElementById('modal-confirm').classList.remove('hidden'); document.getElementById('modal-confirm').classList.add('flex'); };
        window.closeConfirmModal = () => { state.pendingAction = null; document.getElementById('modal-confirm').classList.add('hidden'); document.getElementById('modal-confirm').classList.remove('flex'); };
        document.getElementById('btn-confirm-action').addEventListener('click', () => { if(state.pendingAction) state.pendingAction(); closeConfirmModal(); });
        function showToast(msg, type='info') { const el = document.createElement('div'); const color = type==='error'?'bg-red-500':(type==='success'?'bg-green-600':'bg-slate-800'); el.className = `toast-enter px-6 py-3 rounded-full shadow-2xl text-sm font-bold text-white ${color} flex items-center gap-2`; el.innerHTML = type==='success' ? '‚úÖ '+msg : (type==='error'?'‚ö†Ô∏è '+msg:'‚ÑπÔ∏è '+msg); document.getElementById('toast-container').appendChild(el); setTimeout(()=>el.remove(), 3000); }
        window.openEditSaleModal = (idx) => { state.editingSaleIndex = idx; const sale = state.dailyData.sales[idx]; const prodSel = document.getElementById('edit-sale-prod'); prodSel.innerHTML = state.products.map(p => `<option value="${p.id}" ${p.id===sale.pid?'selected':''}>${p.name}</option>`).join(''); const paySel = document.getElementById('edit-sale-pay'); paySel.innerHTML = state.paymentMethods.map(m => `<option value="${m}" ${m===sale.method?'selected':''}>${m}</option>`).join(''); document.getElementById('edit-sale-qty').value = 1; const modal = document.getElementById('modal-edit-sale'); modal.classList.remove('hidden'); modal.classList.add('flex'); }; 
        window.confirmEditSale = async () => { closeModal('modal-edit-sale'); showToast('Edi√ß√£o Simplificada (Implementar L√≥gica)'); };
        window.openAdjustModal = (m,t) => { state.adjustingMethod = m; document.getElementById('adjust-method-name').textContent = m; document.getElementById('adjust-current-val').textContent = '‚Ç¨' + t.toFixed(2); document.getElementById('inp-adjust-val').value = ''; const modal = document.getElementById('modal-adjust-cash'); modal.classList.remove('hidden'); modal.classList.add('flex'); };
        window.confirmCashAdjustment = async () => { const realVal = parseFloat(document.getElementById('inp-adjust-val').value); if(isNaN(realVal)) return; const data = state.dailyData; const currentTotal = data.sales.filter(s => s.method === state.adjustingMethod).reduce((a,b)=>a+b.price, 0); const diff = realVal - currentTotal; if(Math.abs(diff) < 0.01) return closeModal('modal-adjust-cash'); const adjustmentSale = { id: generateUUID(), pid: 'adjustment', price: diff, method: state.adjustingMethod, ts: Date.now() }; const dateStr = document.getElementById('report-date').value; await setDoc(doc(db, `artifacts/${APP_ID}/public/data`, `DailySales/${dateStr}`), { sales: arrayUnion(adjustmentSale), totalValue: increment(diff) }, {merge: true}); closeModal('modal-adjust-cash'); showToast('Ajuste Realizado', 'success'); };
        window.addPaymentMethod = async () => { const val = document.getElementById('new-pay-method').value.trim(); if(!val) return; const newList = [...state.paymentMethods, val]; await setDoc(doc(db, `artifacts/${APP_ID}/public/data`, 'MasterData/config'), { paymentMethods: newList }, {merge:true}); document.getElementById('new-pay-method').value = ''; };
        window.removePaymentMethod = async (idx) => { if(!confirm('Remover?')) return; const newList = state.paymentMethods.filter((_, i) => i !== idx); await setDoc(doc(db, `artifacts/${APP_ID}/public/data`, 'MasterData/config'), { paymentMethods: newList }, {merge:true}); };
        window.confirmDeleteProduct = () => { openConfirmModal(() => deleteProduct(), "Apagar produto?"); };
        window.clearStreetInputs = () => { state.draftStreetStock = {}; renderStockUI(); };
        window.renderAdminOrderList = renderAdminOrderList;
        window.renderAdminCustomerList = renderAdminCustomerList;
        window.openEditCustomerModal = openEditCustomerModal;
        window.saveCustomerEdit = saveCustomerEdit;
        window.deleteCustomer = deleteCustomer;
        window.openEditOrderModal = openEditOrderModal;
        window.updateEditingOrderCart = updateEditingOrderCart;
        window.saveOrderEdit = saveOrderEdit;
        window.optimizeRoute = optimizeRoute;
        window.openGoogleMapsRoute = openGoogleMapsRoute;

        function renderAdminOrderList() {
             const container = document.getElementById('admin-order-list');
             const list = [...state.allActiveOrders].sort((a,b) => b.ts - a.ts);
             if(list.length === 0) { container.innerHTML = '<p class="text-center text-slate-400 text-sm">Sem pedidos ativos.</p>'; return; }
             container.innerHTML = list.map(o => {
                 const date = o.scheduledDate ? o.scheduledDate.split('-').reverse().join('/') : 'Hoje';
                 const prodSummary = o.products.map(p => { const prodName = state.products.find(x=>x.id===p.id)?.name || '???'; return `${p.qty}x ${prodName}`; }).join(', ');
                 return `<div onclick="openEditOrderModal('${o.id}')" class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm mb-2 relative overflow-hidden"><div class="absolute top-0 right-0 bg-slate-100 text-slate-500 text-[10px] font-bold px-2 py-1 rounded-bl-xl">${date}</div><div class="font-bold text-slate-800">${o.name}</div><div class="text-xs text-slate-500 mb-2">${o.hood}, ${o.num}</div><div class="bg-indigo-50 text-indigo-700 text-xs font-bold p-2 rounded-lg flex justify-between items-center"><span>${prodSummary}</span><span>‚úé Editar</span></div></div>`;
             }).join('');
        }
        function renderAdminCustomerList(filter) {
            const container = document.getElementById('admin-customer-list');
            const term = filter.toLowerCase();
            const list = state.allCustomers.filter(c => (c.name && c.name.toLowerCase().includes(term)) || (c.phone && c.phone.includes(term)));
            if(list.length === 0) { container.innerHTML = '<p class="text-center text-slate-400 text-sm">Nenhum cliente encontrado.</p>'; return; }
            container.innerHTML = list.map(c => `<div onclick="openEditCustomerModal('${c.id}')" class="bg-white p-4 rounded-2xl border border-slate-100 flex justify-between items-center active:bg-slate-50 transition shadow-sm"><div><div class="font-bold text-slate-800">${c.name}</div><div class="text-xs text-slate-500">${c.hood} ‚Ä¢ ${c.phone}</div></div><div class="text-indigo-600 font-bold text-xl">‚Ä∫</div></div>`).join('');
        }
        function openEditCustomerModal(phone) {
            const c = state.allCustomers.find(x => x.id === phone); if(!c) return;
            document.getElementById('edit-cust-id').value = phone; document.getElementById('edit-cust-phone').value = phone; document.getElementById('edit-cust-name').value = c.name || ''; document.getElementById('edit-cust-hood').value = c.hood || ''; document.getElementById('edit-cust-num').value = c.num || ''; document.getElementById('edit-cust-addr').value = c.addr || ''; document.getElementById('edit-cust-obs').value = c.obs || '';
            const modal = document.getElementById('modal-customer-edit'); modal.classList.remove('hidden'); modal.classList.add('flex');
        }
        async function saveCustomerEdit() {
            const phone = document.getElementById('edit-cust-id').value;
            const data = { name: document.getElementById('edit-cust-name').value, hood: document.getElementById('edit-cust-hood').value, num: document.getElementById('edit-cust-num').value, addr: document.getElementById('edit-cust-addr').value, obs: document.getElementById('edit-cust-obs').value };
            const publicPath = `artifacts/${APP_ID}/public/data`; await setDoc(doc(db, publicPath, `Customers/${phone}`), data, {merge:true}); closeModal('modal-customer-edit'); showToast('Cliente atualizado');
        }
        function deleteCustomer() { const phone = document.getElementById('edit-cust-id').value; openConfirmModal(async () => { const publicPath = `artifacts/${APP_ID}/public/data`; await deleteDoc(doc(db, publicPath, `Customers/${phone}`)); closeModal('modal-customer-edit'); showToast('Cliente exclu√≠do'); }, "Deseja excluir este cadastro?"); }
        function openEditOrderModal(orderId) {
            const order = state.allActiveOrders.find(o => o.id === orderId); if(!order) return; state.editingOrderId = orderId;
            document.getElementById('edit-order-id').value = orderId; document.getElementById('edit-order-addr').value = order.addr || ''; document.getElementById('edit-order-hood').value = order.hood || ''; document.getElementById('edit-order-num').value = order.num || ''; document.getElementById('edit-order-obs').value = order.obs || '';
            state.editingOrderCart = {}; state.products.forEach(p => state.editingOrderCart[p.id] = 0); order.products.forEach(p => state.editingOrderCart[p.id] = p.qty);
            renderEditingOrderProducts();
            const modal = document.getElementById('modal-order-edit'); modal.classList.remove('hidden'); modal.classList.add('flex');
        }
        function renderEditingOrderProducts() { const container = document.getElementById('edit-order-product-list'); container.innerHTML = state.products.map(p => { const qty = state.editingOrderCart[p.id] || 0; return `<div class="flex justify-between items-center bg-slate-50 p-2 rounded-xl border border-slate-200"><span class="font-bold text-slate-700 text-sm">${p.name}</span><div class="flex items-center gap-2"><button onclick="updateEditingOrderCart('${p.id}', -1)" class="w-8 h-8 rounded-lg bg-white border border-slate-200 font-bold text-slate-600">-</button><span class="font-bold w-6 text-center text-slate-800">${qty}</span><button onclick="updateEditingOrderCart('${p.id}', 1)" class="w-8 h-8 rounded-lg bg-indigo-100 border border-indigo-200 font-bold text-indigo-600">+</button></div></div>`; }).join(''); }
        function updateEditingOrderCart(id, delta) { const next = (state.editingOrderCart[id] || 0) + delta; if(next < 0) return; state.editingOrderCart[id] = next; renderEditingOrderProducts(); }
        // (saveOrderEdit now defined above)
        function renderPaymentMethods() {
             const container = document.getElementById('pos-payment-grid');
             container.innerHTML = state.paymentMethods.map(m => {
                 const icon = methodIcons[m] || methodIcons['default'];
                 const active = state.payment === m ? 'border-indigo-600 bg-indigo-50 text-indigo-700 ring-2 ring-indigo-200' : 'border-slate-200 bg-white text-slate-600';
                 return `<button id="pay-${m.replace(/\s/g,'')}" onclick="setPayment('${m}')" class="payment-icon-btn ${active} flex flex-col items-center justify-center p-3 rounded-2xl border font-bold text-[10px] uppercase transition-all active:scale-95 h-20"><span class="text-2xl mb-1">${icon}</span>${m}</button>`;
             }).join('');
        }
        window.setPayment = setPayment;
        window.renderPaymentMethods = renderPaymentMethods;
    </script>
</body>
</html>
