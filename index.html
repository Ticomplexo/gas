<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>G√°s App</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f8fafc;
            -webkit-tap-highlight-color: transparent;
        }
        
        #main-content { padding-bottom: 120px; padding-top: 10px; }

        /* Navega√ß√£o */
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 8px 4px;
            color: #94a3b8;
            border-bottom: 3px solid transparent;
            transition: all 0.2s ease-in-out;
        }
        .nav-item.active {
            color: #4f46e5;
            border-color: #4f46e5;
            background-color: #f8fafc;
        }
        .nav-item:active { background-color: #f1f5f9; }

        /* Pagamentos */
        .payment-icon-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 12px;
            border: 2px solid #f1f5f9;
            border-radius: 16px;
            background: white;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        .payment-icon-btn.active {
            border-color: #6366f1;
            background-color: #eef2ff;
            color: #4338ca;
            box-shadow: 0 4px 6px -1px rgba(99, 102, 241, 0.1);
        }
        .payment-icon-btn svg, .payment-icon-btn span.emoji {
            font-size: 26px;
            margin-bottom: 6px;
            filter: drop-shadow(0 2px 2px rgba(0,0,0,0.05));
        }

        /* Card Produto Otimizado */
        .product-card {
            transition: transform 0.1s, box-shadow 0.1s;
        }
        .product-card:active {
            transform: scale(0.99);
        }

        /* Anima√ß√µes */
        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .toast-enter { animation: slideIn 0.3s ease-out forwards; }
    </style>
</head>
<body>

    <!-- Loading -->
    <div id="loading-screen" class="fixed inset-0 bg-white flex flex-col items-center justify-center z-50">
        <div class="animate-spin rounded-full h-12 w-12 border-b-4 border-indigo-600"></div>
        <p class="mt-4 text-indigo-700 font-bold text-sm tracking-wide animate-pulse">CARREGANDO SISTEMA...</p>
    </div>

    <!-- Toast -->
    <div id="toast-container" class="fixed top-4 left-0 w-full z-[70] p-4 pointer-events-none flex flex-col items-center gap-2"></div>

    <!-- App Container -->
    <div id="app-container" class="hidden min-h-screen flex flex-col">
        
        <!-- Header -->
        <header class="bg-white/90 backdrop-blur-md shadow-sm sticky top-0 z-40 border-b border-slate-100">
            <div class="px-5 py-3 flex justify-between items-center">
                <h1 class="text-xl font-black text-slate-800 flex items-center gap-2 tracking-tight">
                    <span class="text-2xl">üî•</span> G√°s Vendas
                </h1>
                <div class="text-[11px] font-bold text-slate-500 bg-slate-100 px-3 py-1.5 rounded-full border border-slate-200">
                    <span id="header-date">--/--/----</span>
                </div>
            </div>
            
            <!-- Abas -->
            <nav class="flex justify-around bg-white border-t border-slate-50">
                <button onclick="switchTab('vendas')" class="nav-item flex-1 active" id="nav-vendas">
                    <span class="text-xl mb-0.5">üõí</span>
                    <span class="text-[10px] font-bold uppercase tracking-wide">Venda</span>
                </button>
                <button onclick="switchTab('estoque')" class="nav-item flex-1" id="nav-estoque">
                    <span class="text-xl mb-0.5">üì¶</span>
                    <span class="text-[10px] font-bold uppercase tracking-wide">Estoque</span>
                </button>
                <button onclick="switchTab('relatorios')" class="nav-item flex-1" id="nav-relatorios">
                    <span class="text-xl mb-0.5">üìä</span>
                    <span class="text-[10px] font-bold uppercase tracking-wide">Relat√≥rios</span>
                </button>
                <button onclick="switchTab('admin')" class="nav-item flex-1" id="nav-admin">
                    <span class="text-xl mb-0.5">‚öôÔ∏è</span>
                    <span class="text-[10px] font-bold uppercase tracking-wide">Admin</span>
                </button>
            </nav>
        </header>

        <!-- Main -->
        <main id="main-content" class="flex-1 p-4 bg-slate-50">
            
            <!-- 1. VENDAS (POS) -->
            <section id="tab-vendas" class="tab-content block">
                <div class="mb-6">
                    <h2 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3 ml-1">Pagamento</h2>
                    <div id="pos-payment-grid" class="grid grid-cols-4 gap-3"></div>
                </div>

                <div>
                    <h2 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3 ml-1">Produtos</h2>
                    <div id="pos-product-list" class="space-y-4"></div>
                    <div class="h-32 w-full"></div> 
                </div>

                <!-- Checkout Bar -->
                <div class="fixed bottom-0 left-0 w-full bg-white/95 backdrop-blur-xl border-t border-slate-200 shadow-[0_-8px_30px_rgba(0,0,0,0.04)] p-4 z-40 pb-safe">
                    <div class="flex justify-between items-end mb-4">
                        <div class="flex flex-col">
                            <span class="text-[11px] text-slate-500 font-bold uppercase tracking-wide">Total a Pagar</span>
                            <span class="text-3xl font-black text-indigo-700 leading-none tracking-tight" id="cart-total">‚Ç¨0,00</span>
                        </div>
                        <span class="text-xs bg-indigo-50 text-indigo-700 border border-indigo-100 px-3 py-1.5 rounded-full font-bold flex items-center gap-1">
                            üõí <span id="cart-count">0</span>
                        </span>
                    </div>
                    <button onclick="finishSale()" id="btn-checkout" disabled class="w-full bg-slate-900 text-white font-bold py-4 rounded-2xl shadow-xl shadow-slate-200 active:scale-[0.98] transition-all disabled:bg-slate-200 disabled:shadow-none disabled:text-slate-400 text-base">
                        Selecione Pagamento
                    </button>
                </div>
            </section>

            <!-- 2. ESTOQUE -->
            <section id="tab-estoque" class="tab-content hidden">
                <div class="bg-white rounded-3xl shadow-sm border border-slate-100 p-6 mb-6">
                    <h3 class="text-sm font-bold text-slate-800 mb-5 flex items-center gap-2">
                        <span class="bg-blue-100 text-blue-600 p-1.5 rounded-lg text-lg">üìä</span> N√≠veis de Estoque
                    </h3>
                    <div id="stock-summary-grid" class="grid grid-cols-2 gap-4"></div>
                </div>

                <div class="bg-white rounded-3xl shadow-sm border border-slate-100 p-6 mb-6">
                    <h3 class="text-sm font-bold text-slate-800 mb-5 flex items-center gap-2">
                        <span class="bg-green-100 text-green-600 p-1.5 rounded-lg text-lg">üöö</span> Entrada de Carga
                    </h3>
                    <div id="stock-inputs-list" class="space-y-4 mb-5"></div>
                    <button onclick="addStockLoad()" class="w-full bg-indigo-50 text-indigo-600 font-bold py-3.5 rounded-xl border border-indigo-100 active:scale-95 transition hover:bg-indigo-100">
                        Confirmar Entrada
                    </button>
                </div>

                <div class="mt-4 mb-20">
                    <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3 ml-1">Hist√≥rico de Cargas</h3>
                    <div id="stock-history-list" class="bg-white rounded-2xl border border-slate-100 divide-y divide-slate-50 overflow-hidden shadow-sm"></div>
                </div>
            </section>

            <!-- 3. RELAT√ìRIOS -->
            <section id="tab-relatorios" class="tab-content hidden">
                <div class="flex justify-between items-center mb-6 bg-white p-4 rounded-2xl border border-slate-100 shadow-sm">
                    <span class="text-sm font-bold text-slate-600">Data Base:</span>
                    <input type="date" id="report-date" class="bg-slate-50 border border-slate-200 text-slate-800 text-sm rounded-lg p-2 font-bold outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100">
                </div>
                
                <button onclick="downloadPDF()" class="w-full mb-6 bg-slate-800 text-white font-bold py-3.5 rounded-2xl shadow-lg shadow-slate-200 active:scale-95 transition flex items-center justify-center gap-2">
                    <span>üñ®Ô∏è</span> Baixar Relat√≥rio PDF
                </button>

                <div class="grid grid-cols-2 gap-3 mb-6">
                    <div class="bg-gradient-to-br from-indigo-600 to-blue-600 text-white p-5 rounded-3xl shadow-lg shadow-indigo-200 relative overflow-hidden">
                        <div class="absolute top-0 right-0 w-16 h-16 bg-white/10 rounded-full -mr-6 -mt-6"></div>
                        <p class="text-xs font-medium text-white/80 mb-1">Faturamento</p>
                        <p class="text-2xl font-black tracking-tight" id="report-kpi-value">‚Ç¨0,00</p>
                    </div>
                    <div class="bg-white text-slate-800 p-5 rounded-3xl shadow-sm border border-slate-100">
                        <p class="text-xs font-bold text-slate-400 uppercase mb-1">Vendas</p>
                        <p class="text-2xl font-black tracking-tight" id="report-kpi-count">0</p>
                    </div>
                </div>

                <div id="report-content" class="space-y-6"></div>
                
                <div class="mt-8">
                     <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3 ml-1">Fluxo de Estoque (Dia)</h3>
                     <div id="stock-movement-report" class="bg-white p-5 rounded-3xl border border-slate-100 shadow-sm"></div>
                </div>
            </section>

            <!-- 4. ADMIN -->
            <section id="tab-admin" class="tab-content hidden">
                <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-1.5 mb-6 flex overflow-x-auto no-scrollbar gap-1">
                    <button onclick="switchAdminTab('prod')" id="admin-tab-prod" class="admin-tab-btn flex-1 py-2.5 text-xs rounded-xl active bg-slate-100 font-bold text-slate-800 whitespace-nowrap px-4 transition">Produtos</button>
                    <button onclick="switchAdminTab('sales')" id="admin-tab-sales" class="admin-tab-btn flex-1 py-2.5 text-xs rounded-xl text-slate-400 font-medium whitespace-nowrap px-4 transition">Vendas</button>
                    <button onclick="switchAdminTab('pay')" id="admin-tab-pay" class="admin-tab-btn flex-1 py-2.5 text-xs rounded-xl text-slate-400 font-medium whitespace-nowrap px-4 transition">Pagamentos</button>
                </div>

                <!-- Admin Content -->
                <div id="admin-content-prod" class="admin-section block">
                    <div class="bg-white border border-slate-100 rounded-3xl p-5 shadow-sm mb-20">
                        <div id="admin-prod-list" class="divide-y divide-slate-50 mb-4"></div>
                        <button onclick="openProductModal('new')" class="w-full bg-indigo-600 text-white font-bold py-3.5 rounded-2xl shadow-lg shadow-indigo-200 active:scale-95 transition hover:bg-indigo-700">
                            + Novo Produto
                        </button>
                    </div>
                </div>

                <div id="admin-content-sales" class="admin-section hidden">
                    <div class="bg-white border border-slate-100 rounded-3xl p-5 shadow-sm mb-20">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-slate-800">Gerenciar Vendas</h3>
                            <span class="text-[10px] font-bold bg-yellow-100 text-yellow-800 px-2 py-1 rounded-md uppercase tracking-wide">Dia Atual</span>
                        </div>
                        <div id="admin-sales-list" class="space-y-3"></div>
                    </div>
                </div>

                <div id="admin-content-pay" class="admin-section hidden mb-20">
                    <div class="bg-white border border-slate-100 rounded-3xl p-5 shadow-sm mb-6">
                        <h3 class="font-bold text-slate-800 mb-3 text-sm uppercase tracking-wide">Ajuste de Caixa</h3>
                        <div id="admin-pay-totals" class="space-y-3"></div>
                    </div>

                    <div class="bg-white border border-slate-100 rounded-3xl p-5 shadow-sm">
                        <h3 class="font-bold text-slate-800 mb-3 text-sm uppercase tracking-wide">M√©todos</h3>
                        <div id="admin-pay-list" class="space-y-2 mb-4"></div>
                        <div class="flex gap-2">
                            <input type="text" id="new-pay-method" placeholder="Novo (ex: Pix)" class="flex-1 border border-slate-200 p-3 rounded-xl text-sm outline-none focus:border-indigo-500 bg-slate-50">
                            <button onclick="addPaymentMethod()" class="bg-green-600 text-white px-4 rounded-xl font-bold text-xl hover:bg-green-700 transition shadow-lg shadow-green-100">+</button>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <!-- MODAIS -->
        <!-- PRODUTO -->
        <div id="modal-product" class="fixed inset-0 bg-slate-900/40 hidden items-center justify-center z-[70] p-4 backdrop-blur-sm transition-opacity">
            <div class="bg-white w-full max-w-sm rounded-[2rem] p-8 shadow-2xl animate-[slideIn_0.2s_ease-out]">
                <h3 class="text-2xl font-black mb-8 text-slate-800 tracking-tight" id="modal-prod-title">Produto</h3>
                <div class="space-y-5">
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1.5 ml-1 tracking-wider">Nome do Item</label>
                        <input type="text" id="inp-prod-name" class="w-full p-4 bg-slate-50 rounded-2xl border border-slate-200 font-bold text-slate-700 outline-none focus:border-indigo-500 focus:ring-4 focus:ring-indigo-50/50 transition-all">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1.5 ml-1 tracking-wider">Pre√ßo (‚Ç¨)</label>
                            <input type="number" id="inp-prod-price" class="w-full p-4 bg-slate-50 rounded-2xl border border-slate-200 font-bold text-slate-700 outline-none focus:border-indigo-500 focus:ring-4 focus:ring-indigo-50/50 transition-all">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1.5 ml-1 tracking-wider">Estoque</label>
                            <input type="number" id="inp-prod-stock" class="w-full p-4 bg-slate-50 rounded-2xl border border-slate-200 font-bold text-slate-700 outline-none focus:border-indigo-500 focus:ring-4 focus:ring-indigo-50/50 transition-all">
                        </div>
                    </div>
                </div>
                <div class="mt-8 flex gap-3">
                    <button onclick="closeModal('modal-product')" class="flex-1 bg-slate-100 text-slate-600 font-bold py-4 rounded-2xl hover:bg-slate-200 transition">Cancelar</button>
                    <button onclick="saveProduct()" class="flex-1 bg-indigo-600 text-white font-bold py-4 rounded-2xl hover:bg-indigo-700 transition shadow-lg shadow-indigo-200">Salvar</button>
                </div>
                <button id="btn-delete-prod" onclick="deleteProduct()" class="w-full mt-4 text-red-400 text-xs font-bold py-2 hover:bg-red-50 rounded-xl transition">Excluir Produto</button>
            </div>
        </div>

        <!-- EDITAR VENDA -->
        <div id="modal-edit-sale" class="fixed inset-0 bg-slate-900/40 hidden items-center justify-center z-[70] p-4 backdrop-blur-sm">
            <div class="bg-white w-full max-w-sm rounded-[2rem] p-8 shadow-2xl animate-[slideIn_0.2s_ease-out]">
                <h3 class="text-2xl font-black mb-2 text-slate-800 tracking-tight">Editar Venda</h3>
                <p class="text-xs text-slate-400 font-medium mb-8">Ajuste de quantidade gera novos registros.</p>
                <div class="space-y-5">
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1.5 ml-1 tracking-wider">Produto</label>
                        <select id="edit-sale-prod" class="w-full p-4 bg-slate-50 rounded-2xl border border-slate-200 font-bold text-slate-700 outline-none focus:border-indigo-500"></select>
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1.5 ml-1 tracking-wider">Quantidade</label>
                        <input type="number" id="edit-sale-qty" value="1" min="0" class="w-full p-4 bg-slate-50 rounded-2xl border border-slate-200 font-bold text-slate-700 outline-none focus:border-indigo-500">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1.5 ml-1 tracking-wider">Pagamento</label>
                        <select id="edit-sale-pay" class="w-full p-4 bg-slate-50 rounded-2xl border border-slate-200 font-bold text-slate-700 outline-none focus:border-indigo-500"></select>
                    </div>
                </div>
                <div class="mt-8 flex gap-3">
                    <button onclick="closeModal('modal-edit-sale')" class="flex-1 bg-slate-100 text-slate-600 font-bold py-4 rounded-2xl">Cancelar</button>
                    <button onclick="confirmEditSale()" class="flex-1 bg-indigo-600 text-white font-bold py-4 rounded-2xl shadow-lg shadow-indigo-200">Confirmar</button>
                </div>
            </div>
        </div>
        
        <!-- AJUSTE CAIXA -->
        <div id="modal-adjust-cash" class="fixed inset-0 bg-slate-900/40 hidden items-center justify-center z-[70] p-4 backdrop-blur-sm">
             <div class="bg-white w-full max-w-sm rounded-[2rem] p-8 shadow-2xl animate-[slideIn_0.2s_ease-out]">
                <h3 class="text-2xl font-black mb-2 text-slate-800 tracking-tight">Ajustar Valor</h3>
                <p class="text-sm text-slate-500 font-medium mb-8">M√©todo: <b id="adjust-method-name" class="text-slate-800"></b></p>
                <div>
                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1.5 ml-1 tracking-wider">Valor Registrado</label>
                    <div id="adjust-current-val" class="text-2xl font-black text-slate-700 mb-6 px-2 tracking-tight">‚Ç¨0.00</div>
                    <label class="block text-[10px] font-bold text-indigo-600 uppercase mb-1.5 ml-1 tracking-wider">Novo Valor Real (‚Ç¨)</label>
                    <input type="number" id="inp-adjust-val" placeholder="Ex: 750.00" class="w-full p-4 bg-indigo-50 rounded-2xl border border-indigo-100 font-black text-xl outline-none focus:border-indigo-500 text-indigo-900 placeholder-indigo-200">
                </div>
                <div class="mt-8 flex gap-3">
                    <button onclick="closeModal('modal-adjust-cash')" class="flex-1 bg-slate-100 text-slate-600 font-bold py-4 rounded-2xl">Cancelar</button>
                    <button onclick="confirmCashAdjustment()" class="flex-1 bg-green-600 text-white font-bold py-4 rounded-2xl shadow-lg shadow-green-200">Salvar</button>
                </div>
            </div>
        </div>

    </div>

    <!-- Script -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, getDoc, updateDoc, arrayUnion, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = JSON.parse('{"apiKey":"AIzaSyDVqXZHzoBNsFd8plj4bvvnXnw2zcvEmlk","authDomain":"vendas-gas.firebaseapp.com","projectId":"vendas-gas","storageBucket":"vendas-gas.firebasestorage.app","messagingSenderId":"477896574192","appId":"1:477896574192:web:fda4b5543aee74afb56e35","measurementId":"G-42GS09Z8PG"}');
        const APP_ID = 'vendas-gas';
        
        let db, auth;
        let state = {
            products: [],
            stock: {},
            cart: {},
            payment: '',
            paymentMethods: ['Dinheiro', 'Cart√£o', 'MBWay', 'Transfer√™ncia'],
            dailyData: null,
            editingProdId: null,
            editingSaleIndex: null, // Note: Now mainly used to retrieve object, but operations use ID
            adjustingMethod: null
        };

        const methodIcons = { 'Dinheiro': 'üíµ', 'Cart√£o': 'üí≥', 'MBWay': 'üì±', 'Transfer√™ncia': 'üè¶', 'default': 'üí∞' };
        
        // Helper Data PT
        const formatDatePT = (dateStr) => {
            if(!dateStr) return '';
            const [y, m, d] = dateStr.split('-');
            return `${d}/${m}/${y}`;
        };

        window.onload = async () => {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                await signInAnonymously(auth);
                auth.onAuthStateChanged(user => { if(user) initApp(); });
            } catch (e) { showToast('Erro Firebase: ' + e.message, 'error'); }
        };

        function initApp() {
            document.getElementById('loading-screen').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            const today = new Date();
            const ptDate = new Intl.DateTimeFormat('pt-PT').format(today);
            document.getElementById('header-date').textContent = ptDate;
            document.getElementById('report-date').value = today.toISOString().split('T')[0];
            setupListeners();
        }

        function setupListeners() {
            const publicPath = `artifacts/${APP_ID}/public/data`;
            onSnapshot(doc(db, publicPath, 'MasterData/products'), snap => {
                if(snap.exists() && snap.data().list) { state.products = snap.data().list; } 
                else { 
                    const seed = [{id:'p1',name:'Butano',price:36},{id:'p2',name:'Propano',price:35}];
                    setDoc(doc(db, publicPath, 'MasterData/products'), {list:seed});
                    state.products = seed;
                }
                updateAllUI();
            });
            onSnapshot(doc(db, publicPath, 'MasterData/config'), snap => {
                if(snap.exists() && snap.data().paymentMethods) state.paymentMethods = snap.data().paymentMethods;
                updateAllUI();
            });
            onSnapshot(doc(db, publicPath, 'MasterData/masterStock'), snap => {
                state.stock = snap.exists() ? snap.data() : {};
                updateAllUI();
            });
            const todayStr = document.getElementById('report-date').value;
            loadDayData(todayStr);
        }

        function updateAllUI() {
            renderPaymentMethods();
            renderProducts();
            renderStockUI();
            renderAdminProdList();
            renderAdminPaySettings();
        }

        function renderPaymentMethods() {
            const container = document.getElementById('pos-payment-grid');
            container.innerHTML = state.paymentMethods.map(m => {
                return `
                <div onclick="setPayment('${m}')" id="pay-${m.replace(/\s/g,'')}" class="payment-icon-btn active:scale-95">
                    <span class="emoji">${methodIcons[m] || 'üí∞'}</span>
                    <span class="text-[10px] font-bold text-slate-600 text-center leading-tight uppercase tracking-wide">${m}</span>
                </div>`;
            }).join('');
        }

        function renderProducts() {
            document.getElementById('pos-product-list').innerHTML = state.products.map(p => {
                const qty = state.cart[p.id] || 0;
                const stock = state.stock[p.id] || 0;
                const soldToday = state.dailyData && state.dailyData.sales ? state.dailyData.sales.filter(s => s.pid === p.id).length : 0;
                
                return `
                <div id="card-${p.id}" class="product-card bg-white p-5 rounded-3xl shadow-sm border border-slate-100 flex justify-between items-center mb-3">
                    <div class="flex-1">
                        <div class="font-bold text-slate-800 text-lg leading-tight mb-0.5">${p.name}</div>
                        <div class="text-indigo-600 font-black text-xl mb-2">‚Ç¨${p.price}</div>
                        <div class="flex items-center gap-2">
                             <div class="bg-slate-100 text-slate-500 px-2 py-1 rounded-lg text-[10px] font-bold uppercase tracking-wider flex items-center gap-1">
                                üì¶ ${stock}
                             </div>
                             <div class="bg-green-50 text-green-700 px-2 py-1 rounded-lg text-[10px] font-bold uppercase tracking-wider flex items-center gap-1">
                                ‚úÖ Vendido: ${soldToday}
                             </div>
                        </div>
                    </div>
                    <div class="flex items-center gap-3 bg-slate-50 p-1.5 rounded-2xl border border-slate-100 ml-3">
                        <button onclick="updateCart('${p.id}', -1)" ${qty<=0?'disabled':''} class="w-11 h-11 flex items-center justify-center rounded-xl bg-white shadow-sm text-slate-600 font-bold disabled:opacity-40 disabled:shadow-none transition active:scale-90 text-xl border border-slate-100">-</button>
                        <span class="font-bold w-6 text-center text-lg text-slate-800">${qty}</span>
                        <button onclick="updateCart('${p.id}', 1)" ${qty>=stock?'disabled':''} class="w-11 h-11 flex items-center justify-center rounded-xl bg-indigo-600 text-white font-bold disabled:bg-slate-200 disabled:text-slate-400 transition active:scale-90 text-xl shadow-md shadow-indigo-200 disabled:shadow-none">+</button>
                    </div>
                </div>`;
            }).join('');
            checkCheckout();
        }

        window.setPayment = (m) => {
            state.payment = m;
            document.querySelectorAll('.payment-icon-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(`pay-${m.replace(/\s/g,'')}`).classList.add('active');
            checkCheckout();
        };

        window.updateCart = (id, d) => {
            const curr = state.cart[id] || 0;
            const stock = state.stock[id] || 0;
            const next = curr + d;
            if(next < 0) return;
            if(next > stock) return showToast('Estoque Insuficiente', 'error');
            state.cart[id] = next;
            renderProducts();
        };

        function checkCheckout() {
            let count = 0, total = 0;
            state.products.forEach(p => {
                const q = state.cart[p.id] || 0;
                count += q; total += q * p.price;
            });
            document.getElementById('cart-count').textContent = count;
            document.getElementById('cart-total').textContent = '‚Ç¨' + total.toFixed(2);
            
            const btn = document.getElementById('btn-checkout');
            if(count > 0 && state.payment) {
                btn.disabled = false;
                btn.textContent = `Finalizar (${state.payment})`;
                btn.classList.remove('bg-slate-900', 'text-white');
                btn.classList.add('bg-green-600', 'text-white', 'shadow-green-200');
            } else {
                btn.disabled = true;
                btn.textContent = state.payment ? 'Selecione Produtos' : 'Selecione Pagamento';
                btn.classList.add('bg-slate-900', 'text-white');
                btn.classList.remove('bg-green-600', 'text-white', 'shadow-green-200');
            }
        }

        window.finishSale = async () => {
            const btn = document.getElementById('btn-checkout');
            btn.textContent = 'Processando...'; btn.disabled = true;
            try {
                const batch = [];
                const updates = {};
                const salesToAdd = [];

                state.products.forEach(p => {
                    const q = state.cart[p.id] || 0;
                    if(q > 0) {
                        // Atomic Update Logic Preparation
                        updates[p.id] = increment(-q);
                        
                        // Prepare sales items with Unique ID
                        for(let i=0; i<q; i++) {
                            salesToAdd.push({ 
                                id: crypto.randomUUID(), // CRITICAL FIX: Unique ID
                                pid: p.id, 
                                price: p.price, 
                                method: state.payment, 
                                ts: Date.now() + i 
                            });
                        }
                    }
                });
                
                const publicPath = `artifacts/${APP_ID}/public/data`;
                const realToday = new Date().toISOString().split('T')[0];

                // 1. Update Stock Atomically
                await updateDoc(doc(db, publicPath, 'MasterData/masterStock'), updates);
                
                // 2. Fetch fresh stock for snapshot integrity
                const freshStockSnap = await getDoc(doc(db, publicPath, 'MasterData/masterStock'));
                const freshStock = freshStockSnap.exists() ? freshStockSnap.data() : {};

                // 3. Update Sales Doc
                const salesRef = doc(db, publicPath, `DailySales/${realToday}`);
                let current = { sales: [], totalSales: 0, totalValue: 0 };
                try {
                    const snap = await getDoc(salesRef);
                    if(snap.exists()) current = snap.data();
                } catch(e) {}
                
                await setDoc(salesRef, {
                    sales: [...(current.sales||[]), ...salesToAdd],
                    totalSales: (current.totalSales||0) + salesToAdd.length,
                    totalValue: (current.totalValue||0) + salesToAdd.reduce((a,b)=>a+b.price,0),
                    finalStock: freshStock // Save true fresh stock
                });

                state.cart = {}; state.payment = '';
                document.querySelectorAll('.payment-icon-btn').forEach(el => el.classList.remove('active'));
                renderProducts();
                showToast('Venda Confirmada!', 'success');
            } catch(e) { showToast('Erro: '+e.message, 'error'); btn.disabled=false; }
        };

        // --- RELAT√ìRIOS ---
        document.getElementById('report-date').addEventListener('change', (e) => loadDayData(e.target.value));

        async function loadDayData(dateStr) {
            if(!db) return;
            const publicPath = `artifacts/${APP_ID}/public/data`;
            onSnapshot(doc(db, publicPath, `DailySales/${dateStr}`), snap => {
                const data = snap.exists() ? snap.data() : { sales: [], totalValue: 0, totalSales: 0, finalStock: null };
                state.dailyData = data;
                renderReports(data);
                renderAdminSalesList(data);
                renderAdminPayTotals(data);
                renderStockFlow(data, dateStr);
                renderProducts(); // Refresh sold counts
            });
        }

        async function renderStockFlow(data, dateStr) {
            const publicPath = `artifacts/${APP_ID}/public/data`;
            const snap = await getDoc(doc(db, publicPath, 'MasterData/stockLoads'));
            const loads = (snap.exists() && snap.data().history) ? snap.data().history : [];
            const loadsToday = loads.filter(l => new Date(l.ts).toISOString().split('T')[0] === dateStr);
            const loadQty = loadsToday.reduce((a,b)=>a+b.qty,0);
            
            let finalStockHtml = '';
            const isToday = dateStr === new Date().toISOString().split('T')[0];

            if (data.finalStock) {
                finalStockHtml = `<div class="mt-4 border-t border-slate-100 pt-3">
                    <h4 class="text-[10px] font-bold text-slate-400 uppercase mb-2 tracking-wider">Estoque Final (Fechamento)</h4>
                    <div class="grid grid-cols-2 gap-2 text-xs">
                        ${Object.keys(data.finalStock).map(pid => {
                             const p = state.products.find(x => x.id === pid);
                             return p ? `<div class="bg-slate-50 p-2 rounded-lg text-slate-600 font-medium flex justify-between"><span>${p.name}</span> <b class="text-slate-900">${data.finalStock[pid]}</b></div>` : '';
                        }).join('')}
                    </div>
                </div>`;
            } else {
                finalStockHtml = `<div class="mt-4 border-t border-slate-100 pt-3 text-xs text-slate-400 italic">${isToday ? 'Estoque atual sendo monitorado...' : 'Estoque final n√£o registrado para esta data.'}</div>`;
            }

            document.getElementById('stock-movement-report').innerHTML = `
             <div class="flex justify-between items-center text-sm mb-2">
                <div>
                    <span class="block text-slate-400 text-[10px] font-bold uppercase">Entradas</span>
                    <span class="font-black text-green-600 text-xl tracking-tight">+${loadQty}</span>
                </div>
                <div class="text-right">
                    <span class="block text-slate-400 text-[10px] font-bold uppercase">Sa√≠das</span>
                    <span class="font-black text-red-500 text-xl tracking-tight">-${state.dailyData ? state.dailyData.totalSales : 0}</span>
                </div>
             </div>
             ${loadsToday.length ? `<div class="mt-2 text-xs text-slate-500 border-t border-slate-100 pt-2 flex flex-wrap gap-1">${loadsToday.map(l=>`<span class="bg-slate-100 px-1.5 py-0.5 rounded text-[10px]">${l.name} (${l.qty})</span>`).join('')}</div>` : ''}
             ${finalStockHtml}
            `;
        }

        function renderReports(data) {
            document.getElementById('report-kpi-value').textContent = '‚Ç¨' + data.totalValue.toFixed(2);
            document.getElementById('report-kpi-count').textContent = data.totalSales;
            if(!data.sales.length) {
                document.getElementById('report-content').innerHTML = '<div class="text-center text-slate-400 py-10 font-medium">Sem vendas hoje.</div>';
                return;
            }
            const byProd = {};
            const byPay = {};
            data.sales.forEach(s => {
                if(!byProd[s.pid]) byProd[s.pid] = { count: 0, total: 0 };
                byProd[s.pid].count++;
                byProd[s.pid].total += s.price;
                byPay[s.method] = (byPay[s.method] || 0) + s.price;
            });
            let html = `<div class="bg-white rounded-3xl border border-slate-100 p-5 shadow-sm">
                <h3 class="text-xs font-bold text-slate-400 uppercase mb-4 tracking-wider">Resumo por Produto</h3>
                <div class="space-y-3">`;
            Object.keys(byProd).forEach(pid => {
                const p = state.products.find(x=>x.id===pid);
                const name = p ? p.name : (pid === 'adjustment' ? 'Ajuste de Caixa' : 'Removido');
                html += `
                <div class="flex justify-between items-center text-sm p-2 hover:bg-slate-50 rounded-xl transition">
                    <span class="font-bold text-slate-700">${name}</span>
                    <div class="flex gap-3 items-center">
                        <span class="text-slate-500 bg-slate-100 px-2 py-1 rounded-lg text-xs font-bold">${byProd[pid].count} un</span>
                        <span class="font-bold text-indigo-600 w-20 text-right">‚Ç¨${byProd[pid].total.toFixed(2)}</span>
                    </div>
                </div>`;
            });
            html += `</div></div>`;
            html += `<div class="bg-white rounded-3xl border border-slate-100 p-5 shadow-sm">
                <h3 class="text-xs font-bold text-slate-400 uppercase mb-4 tracking-wider">Por Pagamento</h3>
                <div class="grid grid-cols-2 gap-3">`;
            Object.keys(byPay).forEach(m => {
                 html += `<div class="bg-slate-50 rounded-2xl p-4 text-center border border-slate-100">
                    <div class="text-[10px] text-slate-400 font-bold uppercase mb-1">${m}</div>
                    <div class="text-lg font-black text-slate-800 tracking-tight">‚Ç¨${byPay[m].toFixed(2)}</div>
                 </div>`;
            });
            html += `</div></div>`;
            document.getElementById('report-content').innerHTML = html;
        }

        // --- PDF GENERATION ---
        window.downloadPDF = () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const dateStr = document.getElementById('report-date').value;
            const data = state.dailyData;

            if (!data) return showToast('Sem dados para imprimir', 'error');

            const formattedDate = formatDatePT(dateStr);

            doc.setFontSize(18);
            doc.text(`Relat√≥rio de Vendas - ${formattedDate}`, 14, 20);

            doc.setFontSize(12);
            doc.text("Resumo Financeiro", 14, 35);
            doc.setFontSize(10);
            doc.text(`Total Geral: ‚Ç¨${data.totalValue.toFixed(2)}`, 14, 42);

            let y = 55;
            doc.setFontSize(12);
            doc.text("Por M√©todo de Pagamento", 14, y);
            y += 7;
            doc.setFontSize(10);
            const byPay = {};
            data.sales.forEach(s => byPay[s.method] = (byPay[s.method] || 0) + s.price);
            Object.keys(byPay).forEach(m => {
                doc.text(`${m}: ‚Ç¨${byPay[m].toFixed(2)}`, 14, y);
                y += 5;
            });

            y += 10;
            doc.setFontSize(12);
            doc.text(`Produtos Vendidos (Total Itens: ${data.totalSales})`, 14, y);
            y += 7;
            doc.setFontSize(10);
            const byProd = {};
            data.sales.forEach(s => {
                if(!byProd[s.pid]) byProd[s.pid] = {count:0, total:0};
                byProd[s.pid].count++; byProd[s.pid].total += s.price;
            });
            Object.keys(byProd).forEach(pid => {
                const p = state.products.find(x=>x.id===pid);
                const name = p ? p.name : (pid === 'adjustment' ? 'Ajuste Manual' : 'Removido');
                doc.text(`${name}: ${byProd[pid].count} un - ‚Ç¨${byProd[pid].total.toFixed(2)}`, 14, y);
                y += 5;
            });

            y += 10;
            doc.setFontSize(12);
            doc.text("Posi√ß√£o de Estoque Final do Dia", 14, y);
            y += 7;
            doc.setFontSize(10);
            
            if (data.finalStock) {
                Object.keys(data.finalStock).forEach(pid => {
                    const p = state.products.find(x=>x.id===pid);
                    if(p) {
                         doc.text(`${p.name}: ${data.finalStock[pid]}`, 14, y);
                         y += 5;
                    }
                });
            } else {
                 doc.text("Estoque final n√£o registrado nesta data.", 14, y);
            }

            doc.save(`relatorio_${dateStr}.pdf`);
        };

        // --- ADMIN ---
        function renderAdminProdList() {
            document.getElementById('admin-prod-list').innerHTML = state.products.map(p => `
                <div class="flex justify-between items-center py-4">
                    <div>
                        <div class="font-bold text-slate-800 text-sm">${p.name}</div>
                        <div class="text-xs text-slate-500 font-medium mt-0.5">‚Ç¨${p.price} ‚Ä¢ Estoque: ${state.stock[p.id]||0}</div>
                    </div>
                    <button onclick="openProductModal('${p.id}')" class="text-indigo-600 font-bold text-xs bg-indigo-50 px-3 py-2 rounded-xl hover:bg-indigo-100 transition">Editar</button>
                </div>
            `).join('');
        }
        function renderAdminSalesList(data) {
            const container = document.getElementById('admin-sales-list');
            if(!data || !data.sales.length) return container.innerHTML = '<p class="text-slate-400 text-xs text-center py-6 font-medium">Sem vendas registradas.</p>';
            container.innerHTML = data.sales.map((s, idx) => {
                const p = state.products.find(x=>x.id===s.pid);
                const name = p ? p.name : (s.pid === 'adjustment' ? 'Ajuste Manual' : 'Removido');
                const isAdj = s.pid === 'adjustment';
                return `
                <div class="flex justify-between items-center p-3 bg-slate-50 rounded-2xl border border-slate-100 text-sm mb-2">
                    <div>
                        <div class="font-bold text-slate-700">${name}</div>
                        <div class="text-xs text-slate-400 font-medium">‚Ç¨${s.price} ‚Ä¢ ${s.method}</div>
                    </div>
                    <div class="flex gap-2">
                        ${!isAdj ? `<button onclick="openEditSaleModal(${idx})" class="text-blue-600 font-bold px-3 py-1.5 bg-blue-50 rounded-xl text-xs">Editar</button>` : ''}
                        <button onclick="deleteSale(${idx})" class="text-red-500 font-bold px-3 py-1.5 bg-red-50 rounded-xl text-xs">Excluir</button>
                    </div>
                </div>`;
            }).join('');
        }
        function renderAdminPaySettings() {
            document.getElementById('admin-pay-list').innerHTML = state.paymentMethods.map((m, idx) => `
                <div class="flex justify-between items-center p-3 bg-slate-50 rounded-2xl border border-slate-100 text-sm">
                    <span class="font-bold text-slate-700">${m}</span>
                    <button onclick="removePaymentMethod(${idx})" class="text-red-400 hover:text-red-600 font-bold px-2 transition">‚úï</button>
                </div>
            `).join('');
        }
        function renderAdminPayTotals(data) {
            const byPay = {};
            data.sales.forEach(s => { byPay[s.method] = (byPay[s.method] || 0) + s.price; });
            document.getElementById('admin-pay-totals').innerHTML = state.paymentMethods.map(m => {
                const total = byPay[m] || 0;
                return `
                <div class="flex justify-between items-center p-4 bg-slate-50 rounded-2xl border border-slate-100">
                    <div>
                        <div class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">${m}</div>
                        <div class="text-lg font-black text-slate-800">‚Ç¨${total.toFixed(2)}</div>
                    </div>
                    <button onclick="openAdjustModal('${m}', ${total})" class="bg-indigo-50 text-indigo-600 px-4 py-2 rounded-xl text-xs font-bold active:scale-95 transition hover:bg-indigo-100">
                        Ajustar
                    </button>
                </div>`;
            }).join('');
        }

        window.openEditSaleModal = (idx) => {
            state.editingSaleIndex = idx;
            const sale = state.dailyData.sales[idx];
            const prodSel = document.getElementById('edit-sale-prod');
            prodSel.innerHTML = state.products.map(p => `<option value="${p.id}" ${p.id===sale.pid?'selected':''}>${p.name}</option>`).join('');
            const paySel = document.getElementById('edit-sale-pay');
            paySel.innerHTML = state.paymentMethods.map(m => `<option value="${m}" ${m===sale.method?'selected':''}>${m}</option>`).join('');
            
            document.getElementById('edit-sale-qty').value = 1;

            const modal = document.getElementById('modal-edit-sale');
            modal.classList.remove('hidden'); modal.classList.add('flex');
        };

        window.confirmEditSale = async () => {
            const idx = state.editingSaleIndex;
            const oldSale = state.dailyData.sales[idx];
            const newPid = document.getElementById('edit-sale-prod').value;
            const newMethod = document.getElementById('edit-sale-pay').value;
            const newQty = parseInt(document.getElementById('edit-sale-qty').value);
            
            if(newQty < 1) return deleteSale(idx);

            const newProdObj = state.products.find(p=>p.id===newPid);
            if(!newProdObj) return;

            // USE ID for safety, though editing usually replaces the object
            const saleId = oldSale.id || null;

            // STOCK LOGIC: Atomic Increment
            const updates = {};
            
            // Revert Old
            updates[oldSale.pid] = increment(1);
            // Apply New Total
            updates[newPid] = increment(-newQty);

            // Execute Stock Update
            await updateDoc(doc(db, `artifacts/${APP_ID}/public/data`, 'MasterData/masterStock'), updates);
            
            // Fetch Fresh Stock
            const freshStockSnap = await getDoc(doc(db, `artifacts/${APP_ID}/public/data`, 'MasterData/masterStock'));
            const freshStock = freshStockSnap.exists() ? freshStockSnap.data() : {};

            // Update Sales List
            const newSalesList = [...state.dailyData.sales];
            const modifiedSale = { ...oldSale, pid: newPid, method: newMethod, price: newProdObj.price };
            newSalesList[idx] = modifiedSale;

            const extraCount = newQty - 1;
            for(let i=0; i < extraCount; i++) {
                newSalesList.push({
                    id: crypto.randomUUID(),
                    pid: newPid,
                    method: newMethod,
                    price: newProdObj.price,
                    ts: Date.now() + i
                });
            }

            const newTotalVal = newSalesList.reduce((a,b)=>a+b.price, 0);

            const dateStr = document.getElementById('report-date').value;
            await setDoc(doc(db, `artifacts/${APP_ID}/public/data`, `DailySales/${dateStr}`), {
                sales: newSalesList,
                totalSales: newSalesList.length,
                totalValue: newTotalVal,
                finalStock: freshStock
            });
            
            closeModal('modal-edit-sale');
            showToast('Venda Atualizada', 'success');
        };

        window.openAdjustModal = (method, currentVal) => {
            state.adjustingMethod = method;
            document.getElementById('adjust-method-name').textContent = method;
            document.getElementById('adjust-current-val').textContent = '‚Ç¨' + currentVal.toFixed(2);
            document.getElementById('inp-adjust-val').value = '';
            const modal = document.getElementById('modal-adjust-cash');
            modal.classList.remove('hidden'); modal.classList.add('flex');
        };

        window.confirmCashAdjustment = async () => {
            const realVal = parseFloat(document.getElementById('inp-adjust-val').value);
            if(isNaN(realVal)) return;
            const data = state.dailyData;
            const currentTotal = data.sales.filter(s => s.method === state.adjustingMethod).reduce((a,b)=>a+b.price, 0);
            const diff = realVal - currentTotal;
            if(Math.abs(diff) < 0.01) return closeModal('modal-adjust-cash');
            const adjustmentSale = { id: crypto.randomUUID(), pid: 'adjustment', price: diff, method: state.adjustingMethod, ts: Date.now() };
            const dateStr = document.getElementById('report-date').value;
            const publicPath = `artifacts/${APP_ID}/public/data`;
            await setDoc(doc(db, publicPath, `DailySales/${dateStr}`), {
                sales: [...data.sales, adjustmentSale],
                totalSales: data.totalSales,
                totalValue: data.totalValue + diff,
                finalStock: data.finalStock 
            });
            closeModal('modal-adjust-cash');
            showToast('Ajuste Realizado', 'success');
        };

        window.deleteStockHistoryItem = async (ts) => {
            if(!confirm('Apagar registro visual?')) return;
            const publicPath = `artifacts/${APP_ID}/public/data`;
            const docRef = doc(db, publicPath, 'MasterData/stockLoads');
            try {
                const snap = await getDoc(docRef);
                if (snap.exists()) {
                    const history = snap.data().history || [];
                    const newHistory = history.filter(h => h.ts !== ts);
                    await setDoc(docRef, { history: newHistory });
                    showToast('Apagado', 'success');
                }
            } catch(e) {}
        };

        function renderStockUI() {
             document.getElementById('stock-summary-grid').innerHTML = state.products.map(p => `
                <div class="flex justify-between p-4 bg-slate-50 rounded-2xl border border-slate-100 items-center">
                    <span class="text-xs font-bold text-slate-600">${p.name}</span>
                    <span class="text-base font-black ${!state.stock[p.id] ? 'text-red-500' : 'text-slate-800'}">${state.stock[p.id]||0}</span>
                </div>
            `).join('');
            document.getElementById('stock-inputs-list').innerHTML = state.products.map(p => `
                <div class="flex items-center gap-3">
                    <span class="text-xs font-bold w-20 truncate text-slate-500">${p.name}</span>
                    <input type="number" id="load-${p.id}" placeholder="Qtd" class="flex-1 p-3.5 bg-slate-50 border border-slate-200 rounded-xl text-sm font-bold text-slate-700 outline-none focus:border-indigo-500 transition">
                </div>
            `).join('');
            getDoc(doc(db, `artifacts/${APP_ID}/public/data`, 'MasterData/stockLoads')).then(snap => {
                 if(snap.exists() && snap.data().history) {
                     const hist = snap.data().history.sort((a,b) => b.ts - a.ts).slice(0, 8);
                     document.getElementById('stock-history-list').innerHTML = hist.map(h => {
                        const d = new Date(h.ts);
                        return `
                        <div class="p-4 text-xs flex justify-between bg-white items-center hover:bg-slate-50 transition">
                            <div class="flex items-center gap-3">
                                <span class="bg-slate-100 text-slate-500 px-2 py-1 rounded-md font-bold">${d.getDate()}/${d.getMonth()+1}</span>
                                <span class="font-bold text-slate-700 text-sm">+${h.qty} ${h.name}</span>
                            </div>
                            <button onclick="deleteStockHistoryItem(${h.ts})" class="w-6 h-6 flex items-center justify-center rounded-full bg-red-50 text-red-500 hover:bg-red-100 font-bold transition">√ó</button>
                        </div>
                     `}).join('');
                 }
            });
        }
        
        window.addStockLoad = async () => {
             const updates = {}; const hist = []; let has=false;
             state.products.forEach(p => {
                 const v = parseInt(document.getElementById(`load-${p.id}`).value);
                 if(v > 0) { 
                     // Atomic Increment
                     updates[p.id] = increment(v); 
                     hist.push({ts:Date.now(),name:p.name,qty:v}); 
                     has=true; 
                 }
             });
             if(!has) return showToast('Preencha quantidades', 'error');
             
             const publicPath = `artifacts/${APP_ID}/public/data`;
             // 1. Update Stock
             await updateDoc(doc(db, publicPath, 'MasterData/masterStock'), updates);
             // 2. Add History
             await setDoc(doc(db, publicPath, 'MasterData/stockLoads'), {history: arrayUnion(...hist)}, {merge:true});
             
             // 3. Fetch Fresh Stock
             const freshStockSnap = await getDoc(doc(db, publicPath, 'MasterData/masterStock'));
             const freshStock = freshStockSnap.exists() ? freshStockSnap.data() : {};
             
             // 4. Update Daily Report with fresh stock
             const realToday = new Date().toISOString().split('T')[0];
             const salesRef = doc(db, publicPath, `DailySales/${realToday}`);
             setDoc(salesRef, { finalStock: freshStock }, {merge: true});

             state.products.forEach(p => document.getElementById(`load-${p.id}`).value = '');
             showToast('Carga Registrada', 'success');
        };

        window.switchTab = (id) => {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${id}`).classList.remove('hidden');
            document.getElementById(`nav-${id}`).classList.add('active');
            if(id === 'relatorios') loadDayData(document.getElementById('report-date').value);
        };
        window.switchAdminTab = (tab) => {
            document.querySelectorAll('.admin-section').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.admin-tab-btn').forEach(el => { el.classList.remove('active', 'bg-slate-100', 'font-bold', 'text-slate-800'); el.classList.add('text-slate-400'); });
            document.getElementById(`admin-content-${tab}`).classList.remove('hidden');
            const btn = document.getElementById(`admin-tab-${tab}`);
            btn.classList.add('active', 'bg-slate-100', 'font-bold', 'text-slate-800');
            btn.classList.remove('text-slate-400');
        };

        window.openProductModal = (id) => {
             document.getElementById('modal-product').classList.remove('hidden');
             document.getElementById('modal-product').classList.add('flex');
             if(id === 'new') {
                 state.editingProdId = null;
                 document.getElementById('inp-prod-name').value = '';
                 document.getElementById('inp-prod-price').value = '';
                 document.getElementById('inp-prod-stock').value = 0;
                 document.getElementById('btn-delete-prod').classList.add('hidden');
                 document.getElementById('modal-prod-title').textContent = 'Novo Produto';
             } else {
                 state.editingProdId = id;
                 const p = state.products.find(x => x.id === id);
                 document.getElementById('inp-prod-name').value = p.name;
                 document.getElementById('inp-prod-price').value = p.price;
                 document.getElementById('inp-prod-stock').value = state.stock[id] || 0;
                 document.getElementById('btn-delete-prod').classList.remove('hidden');
                 document.getElementById('modal-prod-title').textContent = 'Editar Produto';
             }
        };
        window.closeModal = (id) => {
            document.getElementById(id).classList.add('hidden');
            document.getElementById(id).classList.remove('flex');
        };

        window.saveProduct = async () => {
            const name = document.getElementById('inp-prod-name').value;
            const price = parseFloat(document.getElementById('inp-prod-price').value);
            const stock = parseInt(document.getElementById('inp-prod-stock').value);
            if(!name || isNaN(price)) return;
            const publicPath = `artifacts/${APP_ID}/public/data`;
            let list = [...state.products];
            const updates = {};
            if(state.editingProdId) {
                const idx = list.findIndex(p => p.id === state.editingProdId);
                list[idx] = { ...list[idx], name, price };
                updates[state.editingProdId] = stock;
            } else {
                const id = 'prod_' + Date.now();
                list.push({ id, name, price });
                updates[id] = stock;
            }
            await setDoc(doc(db, publicPath, 'MasterData/products'), { list });
            await updateDoc(doc(db, publicPath, 'MasterData/masterStock'), updates);
            closeModal('modal-product');
            showToast('Produto Salvo', 'success');
        };

        window.deleteProduct = async () => {
            if(!state.editingProdId || !confirm('Excluir?')) return;
            const list = state.products.filter(p => p.id !== state.editingProdId);
            await setDoc(doc(db, `artifacts/${APP_ID}/public/data`, 'MasterData/products'), { list });
            closeModal('modal-product');
        };

        // --- FIXED DELETE LOGIC: ATOMIC + ID BASED ---
        window.deleteSale = async (idx) => {
            if(!confirm('Estornar venda?')) return;
            
            const sale = state.dailyData.sales[idx];
            // Filter by ID if present, else by index as fallback (for old data)
            const newSales = sale.id 
                ? state.dailyData.sales.filter(s => s.id !== sale.id)
                : state.dailyData.sales.filter((_, i) => i !== idx);

            const publicPath = `artifacts/${APP_ID}/public/data`;

            // 1. ATOMIC STOCK RESTORE
            if(sale.pid !== 'adjustment') {
                const updates = {};
                updates[sale.pid] = increment(1); // Safely add back to stock
                await updateDoc(doc(db, publicPath, 'MasterData/masterStock'), updates);
            }

            // 2. Fetch Fresh Stock
            const freshStockSnap = await getDoc(doc(db, publicPath, 'MasterData/masterStock'));
            const freshStock = freshStockSnap.exists() ? freshStockSnap.data() : {};

            // 3. Update Sales Record
            const dateStr = document.getElementById('report-date').value;
            await setDoc(doc(db, publicPath, `DailySales/${dateStr}`), {
                sales: newSales,
                totalSales: newSales.filter(s=>s.pid!=='adjustment').length,
                totalValue: newSales.reduce((a,b)=>a+b.price,0),
                finalStock: freshStock
            });
            showToast('Estornado', 'success');
        };

        window.addPaymentMethod = async () => {
            const val = document.getElementById('new-pay-method').value.trim();
            if(!val) return;
            const newList = [...state.paymentMethods, val];
            await setDoc(doc(db, `artifacts/${APP_ID}/public/data`, 'MasterData/config'), { paymentMethods: newList }, {merge:true});
            document.getElementById('new-pay-method').value = '';
            showToast('M√©todo Adicionado', 'success');
        };
        window.removePaymentMethod = async (idx) => {
            if(!confirm('Remover m√©todo?')) return;
            const newList = state.paymentMethods.filter((_, i) => i !== idx);
            await setDoc(doc(db, `artifacts/${APP_ID}/public/data`, 'MasterData/config'), { paymentMethods: newList }, {merge:true});
        };

        window.generateAIReport = async () => { 
             const btn = document.getElementById('btn-ai');
             const resDiv = document.getElementById('ai-result');
             const date = document.getElementById('report-date').value;
             btn.disabled = true; btn.textContent = 'Gerando...'; resDiv.classList.add('hidden');
             const val = document.getElementById('report-kpi-value').textContent;
             const query = `Analise vendas gas data ${date}. Total ${val}. D√™ 1 insight curto.`;
             setTimeout(()=>{
                 resDiv.textContent = "Resumo indispon√≠vel (Demo)."; 
                 resDiv.classList.remove('hidden');
                 btn.disabled = false; btn.innerHTML = '<span>‚ú®</span> Gerar An√°lise Inteligente';
             }, 1000);
        };

        function showToast(msg, type='info') {
            const el = document.createElement('div');
            const color = type==='error'?'bg-red-500':(type==='success'?'bg-green-600':'bg-slate-800');
            el.className = `toast-enter px-6 py-3 rounded-full shadow-2xl text-sm font-bold text-white ${color} flex items-center gap-2`;
            el.innerHTML = type==='success' ? '‚úÖ '+msg : (type==='error'?'‚ö†Ô∏è '+msg:'‚ÑπÔ∏è '+msg);
            document.getElementById('toast-container').appendChild(el);
            setTimeout(()=>el.remove(), 3000);
        }
    </script>
</body>
</html>